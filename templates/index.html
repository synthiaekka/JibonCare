<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HaatXpress</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='/style1.css') }}">

  <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />-->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      <!--background: linear-gradient(to right, #44315d, #522c54, #372a45);-->
      background: #fafafa      min-height: 100vh;
      margin: 0; padding: 0;
    }
    header {
      background-color: #400d2e;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      flex-wrap: wrap;
      box-shadow: 0 3px 9px #21173344;
      position:relative; z-index:20;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo img { width: 60px; height: 60px; filter: drop-shadow(0 4px 10px #0003);}
    .location { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; margin-left: 10px; }
    .nav-main { display: flex; align-items: center; gap: 30px; flex: 1; justify-content: center; }
    .category-dropdown {
      border-radius:10px; padding:7px 16px; font-size:16px; background:#ede2fc; color:#522c54; border:none;
      margin-right:18px; outline:none;
      box-shadow:0 4px 18px #7b1fa22c, 0 1.5px 0 #fff4;
      font-weight:500;
    }
    .category-dropdown:focus { box-shadow:0 0 0 3px #a087e6;}
    .search-bar { display: flex; align-items: center;}
    .search-bar input { padding: 8px 12px; border-radius: 10px 0 0 10px; border: none; font-size: 14px;}
    .search-bar button { padding: 8px 12px; background-color: #ae3e63; color: white; border: none; border-radius: 0 10px 10px 0; cursor: pointer;}
    .auth-cart { display: flex; align-items: center; gap: 20px; }
    .auth-cart a, .auth-cart span { color: white; text-decoration: none; font-weight: 500; }
    .hero {
      text-align: center; color: #0b0b0b;
      padding: 60px 20px 38px 20px;
      text-shadow: 0 6px 14px #18182892;
    }

    .nav-links {
  display: flex;
  align-items: center;
  gap: 20px;
}

.nav-links a {
  color: #fafafa;
  text-decoration: none;
  font-weight: 500;
}

.dropdown {
  position: relative;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #ae3e63;
  min-width: 160px;
  top: 100%;
  left: 0;
  box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
  z-index: 1;
}

.dropdown-content a {
  display: block;
  padding: 10px;
  color: white;
  text-decoration: none;
}

.dropdown:hover .dropdown-content {
  display: block;
}

    .hero h2 { font-size: 2.4rem; letter-spacing:0.2ch; }
    .hero p { font-size: 1.13rem; max-width: 600px; margin: auto; color: #0b0b0b; letter-spacing:0.02ch; }
    .store-section {
      display: flex; flex-wrap: wrap; justify-content: center;
      padding: 40px  3vw; gap: 33px;
    }
    .store-card {
      background: linear-gradient(145deg, #51416c 82%, #422d4c 100%);
      color: white; padding: 22px 12px 19px 12px; border-radius: 17px; min-width:230px; width: 265px;
      box-shadow: 0 4px 35px #22133060, 0 2px 0 #fff1;
      cursor: pointer;
      transition: box-shadow 0.25s, transform 0.19s;
      border: 1.3px solid #765098;
      text-align: center;
      position:relative;
    }
    .store-card:hover {
      background: linear-gradient(135deg, #706eb2 68%, #7a4bc4 100%);
      box-shadow: 0 13px 35px #221330a0, 0 4px 0 #fff4;
      transform: translateY(-7px) scale(1.055) rotate(-1deg);
      border-color:#ae3e63;
    }
    .store-card img {
      width:70px; height:70px;
      margin: 8px auto 17px auto; display:block; border-radius:15px; object-fit: cover; box-shadow: 0 3px 16px #0004;
    }
    .store-card h3 { margin:10px 0 6px 0; font-size: 1.18em; font-weight:700; letter-spacing:.01em;}
    .category-badge {
      display:inline-block; border-radius:9px; font-size:13px; color:#223146; background:#fafafa;
      padding:2.5px 12px; margin-bottom:7px; font-weight:500; box-shadow:0 1.5px 0 #c6fff9;
    }
    .store-dist {font-size: 12px; color: #b6d8ff; margin: 5px;}
    .modal {
      display: none; position: fixed; top: 10%; left: 10%; width: 80%; max-width:420px; min-width:280px; background: rgba(55, 42, 69, 0.97); color: #fff; border-radius: 18px; padding: 36px 34px 28px 34px; overflow-y: auto; z-index:999;
      box-shadow:0 6px 38px #3b1f5060;
    }
    .modal.active { display: block; }
    .modal-close { float: right; background: #ae3e63; border: none; padding:10px 19px; border-radius: 5px; color: white; cursor: pointer;}
    .modal ul { margin:35px 0 0 0; padding:0; list-style:none;}
    .modal li { margin:13px 0; padding:7px 0 7px 12px; border-radius:8px; background:#534160; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2.5px 10px #6288661a;}
    .modal li button { padding:4px 13px; background: #AD5E78FF; color:#372a45; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
    .modal li button:hover { background:#fafafa; color:#0b0b0b;}
    .modal h2 { margin-bottom: 7px;}
    #total-price {margin-top:15px; font-size:1.01em;}
    footer { background-color: #0b0b0b; color: #fafafa; text-align: center; padding: 20px;}
    .login-modal { display: none; position: fixed; left: 0; right: 0; top: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(40,21,64,0.80); z-index: 3000; text-align: center; color: #fff; min-height: 0; justify-content: center; align-items: center;}
    .login-modal.active { display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadein .27s; }
    @keyframes fadein { from { opacity: 0; } to   { opacity: 1; } }
    .login-modal h2 { font-size: 1.7em; margin-bottom: 10px; }
    .login-modal p { font-size:1.1em; color:#ccc; margin-bottom: 25px;}
    .login-modal a { background: #6a8973; display: inline-block; margin: 10px 16px; padding: 12px 32px; border-radius: 8px; color:#fff; text-decoration: none; font-weight:600; font-size:1.1em; transition: background .18s;}
    .login-modal a:hover { background:#44315d;}
    .login-modal button { margin-top: 30px; padding: 8px 25px; border-radius:7px; background:#e74c3c; color: #fff; border: none; font-size:1em; font-weight:bold;}
    .modal { z-index:1500; }
    @media (max-width:700px){
      .store-section { flex-direction:column; }
      .store-card { width:98vw; min-width:97vw;}
      .modal { left:2vw; width:96vw; }
    }
  </style>
</head>
<body>
  <!-- HEADER 
  <header>
    <div class="logo">
      <img src="{{ url_for('static', filename='images/jiboncare_Logo.png') }}" alt="HaatXpress Logo">
      <div class="location">
        <i class="fas fa-map-marker-alt"></i>
        <span id="location-text">Detecting your location...</span>
        <button onclick="detectLocation()" style="margin-left:7px;background:#7f58e7;color:#fff;border:none;border-radius:5px;padding:3px 10px;cursor:pointer;">
          <i class="fa fa-crosshairs"></i> Update
        </button>
      </div>
    </div>
    <div class="nav-main">
      <label style="color:#ede2fc; font-weight:600; margin-right:7px;">Select Category:</label>
      <select id="categorySelect" class="category-dropdown" onchange="categoryChanged()">
        <option value="">All</option>
        <option value="grocery">Grocery</option>
        <option value="medicine">Medicine</option>
        <option value="food-item">Restaurant</option>
      </select>
      <div class="search-bar">
        <input id="searchInput" type="text" placeholder="Search store, product or location..." onkeyup="triggerSmartSearch()" />
        <button><i class="fas fa-search"></i></button>
      </div>
    </div>
    <div class="auth-cart">
      {% if user_email %}
        <span style="color:#6a8973;">{{ user_email }}</span>
        <a href="/logout">Logout</a>
      {% else %}
        <a href="/register">Register</a>
        <a href="/login">Login</a>
      {% endif %}
      <a href="#">
        <i class="fas fa-shopping-cart" style="position: relative;">
          <span id="cart-count" style="position: absolute;top: -8px;right: -10px;background: #6a8973;color: white;font-size: 10px;padding: 2px 5px;border-radius: 50%;">0</span>
        </i>
      </a>
    </div>
  </header>-->

  <!-- HEADER -->
<header>
  <div class="logo">
    <img src="{{ url_for('static', filename='images/jiboncare_Logo.png') }}" alt="HaatXpress Logo" style="width: 60px; height: 60px;">
    <div class="location">
    <i class="fas fa-map-marker-alt"></i>
    <span id="location-text">Detecting your location...</span>
  </div>

  </div>

  <!--<div class="nav-main">
    <div class="nav-links">
      <a href="#">Home</a>
      <a href="#">About</a>
      <div class="dropdown">
        <a href="#">Choose Store</a>
        <div class="dropdown-content">
          <a href="#">Grocery</a>
          <a href="#">Medicine</a>
          <a href="#">Restaurant</a>
        </div>
      </div>
    </div>-->

    <!-- NAVIGATION LINKS -->
<div class="nav-main">
  <div class="nav-links">
    <a href="/" style="color: #fafafa; text-decoration: none; font-weight: 500;">Home</a>
    <a href="/about" style="color: white; text-decoration: none; font-weight: 500;">About</a>

    <div class="dropdown">
      <a href="#" style="color: #fafafa; text-decoration: none; font-weight: 500;">Choose Store</a>
      <div class="dropdown-content">
        <a href="{{ url_for('grocery') }}">Grocery</a>
        <a href="{{ url_for('medicine') }}">Medicine</a>
        <a href="{{ url_for('restaurant') }}">Restaurant</a>

        <!--<a href="#" onclick="filterCategory('medicine')">Medicine</a>
        <a href="#" onclick="filterCategory('food-item')">Restaurant</a>-->
      </div>
    </div>
  </div>



    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search store, product or location..." onkeyup="triggerSmartSearch()" />
      <button><i class="fas fa-search"></i></button>
    </div>
  </div>

  <!--<div class="auth-cart">
    {% if user_email %}
      <span style="color:#6a8973;">{{ user_email }}</span>
      <a href="/logout">Logout</a>
    {% else %}
      <!--<a href="/register">Register</a>-
      <a href="/login">Login</a>
    {% endif %}
    <a href="#">
      <i class="fas fa-shopping-cart" style="position: relative;">
        <span id="cart-count" style="
          position: absolute;
          top: -8px;
          right: -10px;
          background: #6a8973;
          color: white;
          font-size: 10px;
          padding: 2px 5px;
          border-radius: 50%;
        ">0</span>
      </i>
    </a>
  </div>-->
  <div class="auth-cart">
  {% if user_email %}
    <div class="dropdown">
      <a href="#" class="btn">{{ user_name or user_email.split('@')[0] }}</a>
      <div class="dropdown-content">
        <a href="#">Profile</a>
        <a href="/logout">Logout</a>
      </div>
    </div>
  {% else %}
    <a href="/login">Login</a>
  {% endif %}
  <a href="#">
    <i class="fas fa-shopping-cart" style="position: relative;">
      <span id="cart-count" style="
        position: absolute;
        top: -8px;
        right: -10px;
        background: #6a8973;
        color: white;
        font-size: 10px;
        padding: 2px 5px;
        border-radius: 50%;
      ">0</span>
    </i>
  </a>
</div>


  
</header>


  <!-- HERO -->
  <div class="hero">
    <h2>Welcome to HaatXpress</h2>
    <p>Connecting you directly to local shops - groceries, medicines, food, all from your trusted neighborhood within your zone.Stay happyüòÄ‚ù§Ô∏è</p>
  </div>

  <!-- SHOPS LIST -->
  <div class="store-section" id="store-list">
    <div style="color:white;text-align:center;width:100%;">Loading all shops...</div>
  </div>

  <!-- MODAL: Products of this shop -->
  <div class="modal" id="modal" onclick="clickOutsideModal(event)">
    <button class="modal-close" onclick="closeModal()">Close</button>
    <h2 id="modal-title">Store Name</h2>
    <ul id="product-list"></ul>
    <p id="total-price" style="margin-top:20px;font-weight:bold;">Total: ‚Çπ0</p>
  </div>

  <!-- LOGIN/SIGNUP PROMPT MODAL -->
  <div class="login-modal" id="loginModal">
    <h2>Please Login or Register</h2>
    <p>You must be logged in to add items to your cart.</p>
    <a href="/login">Login</a>
    <a href="/register">Register</a>
    <br>
    <button onclick="closeLoginModal()">Cancel</button>
  </div>

  <!-- FOOTER -->
  <footer>
    <p>&copy; 2025 HaatXpress. Made with üß° for your neighborhood.</p>
    <p>Contact: <a href="mailto:support@haatexpress.com" style="color:#6a8973;">support@haatexpress.com</a></p>
  </footer>

<script>
let cart = [];
let total = 0;
const USER_LOGGED_IN = "{{ user_email|default('') }}";
let USER_LAT = null, USER_LNG = null;
let GLOBAL_SHOPS = [];
let CATEGORY = "";

// --- LOCATION ---

function detectLocation() {
  document.getElementById('location-text').innerText = 'Detecting your location...';
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        USER_LAT = pos.coords.latitude;
        USER_LNG = pos.coords.longitude;
        document.getElementById('location-text').innerText = Lat: ${USER_LAT.toFixed(4)}, Lng: ${USER_LNG.toFixed(4)};
        loadShops();
      },
      function(err) {
        document.getElementById('location-text').innerText = "Location unavailable";
        USER_LAT = USER_LNG = null;
        loadShops();
      }
    );
  } else {
    document.getElementById('location-text').innerText = "Geolocation not supported";
    USER_LAT = USER_LNG = null;
  }
}

// --- SMART SHOP LOAD + SEARCH ---

function categoryChanged() {
  CATEGORY = document.getElementById('categorySelect').value;
  document.getElementById('searchInput').value = "";
  loadShops();
  closeModal();
}

function loadShops() {
  let url = '/customer/shops';
  let params = [];
  if(CATEGORY) params.push('category=' + encodeURIComponent(CATEGORY));
  if (USER_LAT !== null && USER_LNG !== null) {
    params.push("lat=" + encodeURIComponent(USER_LAT));
    params.push("lng=" + encodeURIComponent(USER_LNG));
  }
  if (params.length) url += '?' + params.join('&');

  fetch(url)
    .then(res => res.json())
    .then(shops => {
      GLOBAL_SHOPS = shops;
      displayShops(shops);
    });
}

function displayShops(shoplist) {
  let html = '';
  const text = document.getElementById('searchInput').value.trim().toLowerCase();
  for (const s of shoplist) {
    if(text && !(
      ((s.shop_name||'') + ' ' + (s.shop_address||'') + ' ' + (s.shop_contact||'')).toLowerCase().includes(text)
      || (s.matching_products && s.matching_products.join(' | ').toLowerCase().includes(text))
    )) continue; // frontend filter for shop name/address/search combo

    html += 
      <div class="store-card"
        data-name="${(s.shop_name||'') + ' ' + (s.shop_address||'') + ' ' + (s.shop_contact||'')}"
        onclick="showShopProducts('${s.email.replace(/'/g,"&#39;")}', '${(s.shop_name||'Store').replace(/'/g,"&#39;")}')">
        <span class="category-badge">
         ${s.shop_type === 'grocery' ? 'Grocery' : s.shop_type === 'medicine' ? 'Medicine' : s.shop_type === 'food-item' ? 'Restaurant' : 'Other'}
        </span>
        <img src="${s.shop_photo || '/static/default-avatar.png'}" />
        <h3>${s.shop_name || 'Unnamed Shop'}</h3>
        <div style='font-size:13px; color:#c1f6b3; margin-bottom:8px;'>${s.shop_contact || ''}</div>
        <div style='font-size:13px; color:#dedede;'>${s.shop_address || ''}</div>
        ${s.distance_km !== undefined ? <div class="store-dist">Distance: ${s.distance_km} km</div> : ""}
        ${s.matching_products && s.matching_products.length
           ? <div style="margin-top:7px;color:#a6fff8;font-size:13px;"><b>Matched products:</b> ${s.matching_products.join(', ')}</div>
           : ""}
      </div>
    ;
  }
  document.getElementById('store-list').innerHTML = html || '<div style="color:white;">No shops found for search or filters.</div>';
}

function triggerSmartSearch() {
  const text = document.getElementById('searchInput').value.trim().toLowerCase();
  // If no text: just reload from backend
  if (!text) { loadShops(); return; }

  let cat = CATEGORY || document.getElementById('categorySelect').value;
  let url = /customer/search-shops-by-product?query=${encodeURIComponent(text)};
  if(cat) url += &category=${encodeURIComponent(cat)};
  if (USER_LAT !== null && USER_LNG !== null)
    url += &lat=${USER_LAT}&lng=${USER_LNG};

  fetch(url)
    .then(res => res.json())
    .then(productShops => {
      // Also include direct text search on those currently shown
      let matchedShops = (GLOBAL_SHOPS||[]).filter(s =>
        ((s.shop_name||'') + ' ' + (s.shop_address||'') + ' ' + (s.shop_contact||'')).toLowerCase().includes(text)
      );
      let combined = [];
      let ids = new Set();
      for (let shop of productShops) {
        combined.push(shop); ids.add(shop.email);
      }
      for (let shop of matchedShops) {
        if (!ids.has(shop.email)) { combined.push(shop); ids.add(shop.email);}
      }
      displayShops(combined);
    });
}


function filterCategory(category) {
  document.getElementById('categorySelect').value = category;
  categoryChanged();
}

// --- Product modal, cart logic and login modal (unchanged) ---

function showShopProducts(shop_email, shop_name) {
  document.getElementById('modal').classList.add('active');
  document.getElementById('modal-title').innerText = shop_name;
  document.getElementById('total-price').innerText = Total: ‚Çπ${total};
  fetch(/customer/products/${encodeURIComponent(shop_email)})
    .then(res=>res.json())
    .then(products => {
      let ul = document.getElementById('product-list');
      ul.innerHTML = "";
      if (!products.length) {
        ul.innerHTML = "<li>No products yet.</li>";
        return;
      }
      for (const p of products) {
        let li = document.createElement('li');
        li.innerHTML = <span>${p.name} <b>- ‚Çπ${p.price}</b> <span style="color:#eee;font-size:12px;">(${p.type})</span></span>
          <button onclick="event.stopPropagation();addToCart('${p.name.replace(/'/g,"&#39;")}', ${+p.price});">Add to Cart</button>;
        ul.appendChild(li);
      }
    });
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
}
function clickOutsideModal(event) {
  if (event.target.id === "modal") closeModal();
}

function addToCart(name, price) {
  if (!USER_LOGGED_IN) {
    showLoginModal();
    return;
  }
  cart.push({ name, price });
  total += price;
  document.getElementById('cart-count').innerText = cart.length;
  document.getElementById('total-price').innerText = Total: ‚Çπ${total};
}
function showLoginModal() {
  document.getElementById('loginModal').classList.add('active');
}
function closeLoginModal() {
  document.getElementById('loginModal').classList.remove('active');
}

// --- Initial load: get location, then show shops
window.onload = function() {
  CATEGORY = "";
  detectLocation();
  document.getElementById('categorySelect').value = "";
};


document.addEventListener("DOMContentLoaded", () => {
  const locationSpan = document.getElementById("location-text");

  // Check for geolocation support
  if (!navigator.geolocation) {
    locationSpan.innerText = "Geolocation not supported";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (position) => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      try {
        const response = await fetch(https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json);
        if (!response.ok) throw new Error("Failed to fetch location");

        const data = await response.json();

        const place =
          data.address.city ||
          data.address.town ||
          data.address.village ||
          data.address.hamlet ||
          data.address.suburb ||
          data.address.county ||
          data.address.state_district ||
          data.address.state;

        const country = data.address.country || "";
        locationSpan.innerText = ${place ? place + ", " : ""}${country};
      } catch (error) {
        console.error("Reverse geocoding failed:", error);
        locationSpan.innerText = "Location unavailable";
      }
    },
    (error) => {
      console.error("Geolocation failed:", error);
      switch (error.code) {
        case error.PERMISSION_DENIED:
          locationSpan.innerText = "Permission denied";
          break;
        case error.POSITION_UNAVAILABLE:
          locationSpan.innerText = "Location unavailable";
          break;
        case error.TIMEOUT:
          locationSpan.innerText = "Timeout getting location";
          break;
        default:
          locationSpan.innerText = "Location detection error";
      }
    }
  );
});
</script>
</body>
</html>