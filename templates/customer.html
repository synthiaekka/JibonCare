<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HaatXpress Customer - Search, Store & Cart</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #443315);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      color: white;
      user-select: none;
    }
    header {
      background-color: #5C3A21;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      flex-wrap: wrap;
      gap: 12px;
      user-select: none;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .logo img {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      user-select: none;
    }
    .location {
      font-size: 1rem;
      color: #FFD366;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    /* Navigation textual menu */
    nav.nav-main {
      display: flex;
      align-items: center;
      gap: 30px;
      flex-wrap: wrap;
      flex: 1;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1em;
      user-select: none;
    }
    nav.nav-main a {
      color: white;
      background: transparent;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    nav.nav-main a:hover,
    nav.nav-main a:focus {
      background-color: #7f58e7;
      outline: none;
      color: white;
    }
    /* Category dropdown and search bar (optional) */
    select.category-dropdown {
      border-radius: 10px;
      padding: 7px 16px;
      font-size: 16px;
      background: #ede2fc;
      color: #522c54;
      border: none;
      box-shadow: 0 4px 18px #7b1fa22c, 0 1.5px 0 rgba(11, 5, 5, 0.267);
      font-weight: 500;
      outline: none;
      cursor: pointer;
      user-select: none;
    }
    select.category-dropdown:focus {
      box-shadow: 0 0 0 3px #08070d;
    }
    .search-bar {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }
    .search-bar input {
      padding: 8px 12px;
      border-radius: 8px 0 0 8px;
      border: none;
      font-size: 14px;
      min-width: 240px;
      outline: none;
      color: #5C3A21;
    }
    .search-bar button {
      padding: 8px 12px;
      background-color: #6a8973;
      color: white;
      border: none;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
    }
    /* Stores grid */
    .store-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 30px 12px;
      gap: 24px;
      max-width: 1000px;
      margin: 0 auto;
      user-select: none;
    }
    .store-card {
      background-color: #060507;
      color: white;
      padding: 20px;
      border-radius: 14px;
      width: 260px;
      cursor: pointer;
      transition: transform 0.22s, background-color 0.22s;
      border: 1px solid #6a8973;
      text-align: center;
      user-select: none;
    }
    .store-card:hover {
      background-color: #355235;
      transform: translateY(-6px);
    }
    .store-card img {
      width: 64px;
      height: 64px;
      margin: 8px auto 14px auto;
      display: block;
      border-radius: 10px;
      object-fit: cover;
    }
    .category-badge {
      display: inline-block;
      border-radius: 8px;
      font-size: 13px;
      color: #31285b;
      background: #a6fff8;
      padding: 2px 10px;
      margin-bottom: 7px;
      font-weight: 600;
    }
    .matched-products {
      margin-top: 8px;
      color: #a6fff8;
      font-size: 13px;
      font-style: italic;
    }
    .location-small {
      font-size: 13px;
      color: #dedede;
      margin-top: 4px;
      min-height: 40px;
    }
    .contact-small {
      font-size: 13px;
      color: #c1f6b3;
      margin-bottom: 8px;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 10vh;
      left: 50%;
      transform: translateX(-50%);
      width: 90vw;
      max-width: 460px;
      background: rgba(60, 38, 90, 0.97);
      border-radius: 24px;
      padding: 40px 36px 25px 36px;
      color: #fff;
      z-index: 10000;
      box-shadow: 0 8px 35px rgba(90, 41, 200, 0.13);
      max-height: 80vh;
      overflow-y: auto;
      user-select: none;
    }
    .modal.active {
      display: block;
    }
    .modal-close {
      background: #32473c;
      border: none;
      color: white;
      padding: 7px 19px;
      border-radius: 9px;
      font-weight: bold;
      position: absolute;
      top: 18px;
      right: 20px;
      cursor: pointer;
      user-select: none;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .product-list-modal li {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
    }
    .add-cart-btn {
      background: #a8eeaf;
      border: none;
      padding: 6px 19px;
      color: #273f25;
      border-radius: 9px;
      font-weight: 600;
      font-size: 0.97em;
      cursor: pointer;
      transition: background 0.14s;
      user-select: none;
    }
    .add-cart-btn:hover {
      background: #9bd5fc;
      color: #0d0d0f;
    }
    #total-price {
      text-align: right;
      font-weight: bold;
      margin-top: 16px;
      font-size: 1.1em;
      user-select: none;
    }
    /* Cart Modal */
    #cartModal {
      max-width: 520px;
    }
    #cartModal h3 {
      margin-top: 0;
      margin-bottom: 20px;
    }
    #cart-items li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #493d5f;
      padding: 10px 15px;
      margin-bottom: 12px;
      border-radius: 10px;
      font-weight: 500;
      user-select: none;
    }
    #cart-items li button {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 7px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 12px;
      transition: background 0.15s;
      user-select: none;
    }
    #cart-items li button:hover {
      background: #c0392b;
    }
    #cart-total {
      font-weight: bold;
      font-size: 1.2em;
      text-align: right;
      margin-top: 15px;
      color: #a6fff8;
    }
    #cart-actions {
      margin-top: 25px;
      display: flex;
      justify-content: space-between;
    }
    #cart-actions button {
      flex: 1;
      margin: 0 6px;
      padding: 12px 0;
      font-weight: bold;
      font-size: 1em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
      user-select: none;
    }
    #pay-online-btn {
      background: #7750b1;
      color: #fff;
    }
    #pay-offline-btn {
      background: #ffdfa6;
      color: #0e0d0f;
    }
    #pay-online-btn:hover, #pay-offline-btn:hover {
      filter: brightness(0.9);
    }
    #place-order-btn {
      margin-top: 20px;
      width: 100%;
      padding: 14px 0;
      background: #0e7f50;
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #place-order-btn:disabled {
      background: #777;
      cursor: not-allowed;
      color: #ccc;
    }
    /* Address Modal */
    #addressModal {
      max-width: 480px;
    }
    #addressModal h3 {
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 700;
      user-select: none;
    }
    #addressForm label {
      font-weight: 600;
      margin-top: 12px;
      display: block;
      user-select: none;
    }
    #addressForm input,
    #addressForm textarea {
      width: 100%;
      padding: 8px 11px;
      margin-top: 4px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      font-family: inherit;
      box-sizing: border-box;
      resize: vertical;
      user-select: text;
      color: #222;
    }
    #addressForm textarea {
      min-height: 70px;
    }
    #addressForm button {
      margin-top: 16px;
      padding: 12px 18px;
      font-weight: 700;
      font-size: 1em;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
      font-family: 'Poppins', sans-serif;
      user-select: none;
    }
    #addressForm button.submit-btn {
      background-color: #7750b1;
      color: white;
      margin-right: 12px;
    }
    #addressForm button.cancel-btn {
      background-color: #c0392b;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/static/images/jiboncare_Logo.png" alt="HaatXpress Logo" />
      <div class="location" id="location-wrapper">
        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
        <span id="location-text" aria-live="polite" aria-atomic="true">Detecting your location...</span>
      </div>
    </div>
    <nav class="nav-main" aria-label="Main navigation">
      <a href="/" tabindex="0">Home</a>
      <a href="/about" tabindex="0">About</a>
      <a href="#" onclick="showMyOrders()" tabindex="0">My Orders</a>
      <a href="#" onclick="showCartModal()" tabindex="0">Cart (<span id="cart-count" aria-live="polite" aria-atomic="true">0</span>)</a>
    </nav>
    <select id="catSelect" class="category-dropdown" onchange="categoryChanged()" aria-label="Select category">
      <option value="">All Categories</option>
      <option value="grocery">Grocery</option>
      <option value="medicine">Medicine</option>
      <option value="food-item">Restaurant</option>
    </select>
    <div class="search-bar">
      <input
        id="searchInput"
        type="text"
        placeholder="Search store, product or location..."
        onkeyup="liveFilterShop()"
        autocomplete="off"
        aria-label="Search store, product or location"
      />
      <button onclick="liveFilterShop()" aria-label="Search">
        <i class="fas fa-search" aria-hidden="true"></i>
      </button>
    </div>
  </header>

  <main>
    <section class="store-section" id="store-list" aria-label="List of shops">
      <div style="width: 100%; text-align: center; margin-top: 80px; font-size: 1.2em; color: white;">
        Loading shops...
      </div>
    </section>

    <section class="store-section" id="items-list" aria-label="Items for selected shop" style="display:none;">
      <h2 id="items-list-title" style="width:100%; text-align:center; margin-bottom: 24px;"></h2>
      <!-- Items cards will be appended here -->
    </section>

    <section class="store-section" id="my-orders-list" aria-label="My orders" style="display:none; max-width: 600px; margin: 30px auto; color: white;">
      <h2 style="width: 100%; text-align: center; margin-bottom: 20px;">My Orders</h2>
      <div id="my-orders-content" style="font-size: 1em;"></div>
      <button onclick="closeMyOrders()" style="margin: 20px auto; display: block; padding: 10px 20px; font-weight: 600; border-radius: 8px; border:none; background: #7f58e7; color: white; cursor: pointer;">Close Orders</button>
    </section>
  </main>

  <!-- PRODUCT MODAL -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
    <button class="modal-close" aria-label="Close product modal" onclick="closeModal()">Close</button>
    <h2 id="modal-title">Store Name</h2>
    <div class="shop-info" id="modal-shop-info" style="margin-bottom:10px;"></div>
    <ul id="product-list"></ul>
    <div id="total-price">Total: ₹0</div>
  </div>

  <!-- CART MODAL -->
  <div id="cartModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cartModalTitle" tabindex="-1">
    <button class="modal-close" aria-label="Close cart modal" onclick="closeCartModal()">Close</button>
    <h3 id="cartModalTitle">Your Cart</h3>
    <ul id="cart-items"></ul>
    <div id="cart-total">Total: ₹0</div>
    <div id="cart-actions">
      <button id="pay-online-btn" onclick="selectPayment('online')" type="button">Pay Online</button>
      <button id="pay-offline-btn" onclick="selectPayment('offline')" type="button">Cash on Delivery (COD)</button>
    </div>
    <button id="place-order-btn" disabled onclick="openAddressModal()">Place Order</button>
  </div>

  <!-- ADDRESS MODAL -->
  <div id="addressModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addressModalTitle" tabindex="-1">
    <button class="modal-close" aria-label="Close address modal" onclick="closeAddressModal()">Close</button>
    <h3 id="addressModalTitle">Delivery Details</h3>
    <form id="addressForm" onsubmit="submitOrder(event)">
      <label for="custName">Name:</label>
      <input type="text" id="custName" name="custName" required autocomplete="name" />

      <label for="whatsappNum">WhatsApp Number:</label>
      <input
        type="tel"
        id="whatsappNum"
        name="whatsappNum"
        placeholder="10 digit number"
        pattern="[0-9]{10}"
        required
        autocomplete="tel"
      />

      <label for="phoneNum">Phone Number:</label>
      <input
        type="tel"
        id="phoneNum"
        name="phoneNum"
        placeholder="10 digit number"
        pattern="[0-9]{10}"
        required
        autocomplete="tel"
      />

      <label for="emailAddr">Email:</label>
      <input type="email" id="emailAddr" name="emailAddr" required autocomplete="email" />

      <label for="custAddr">Delivery Address:</label>
      <textarea id="custAddr" name="custAddr" required></textarea>

      <label>Payment Mode:</label>
      <div style="margin-bottom: 14px;">
        <label><input type="radio" name="paymentMode" value="online" required /> Online Payment</label><br />
        <label><input type="radio" name="paymentMode" value="offline" /> Cash on Delivery (COD)</label>
      </div>

      <button type="submit" class="submit-btn">Submit Order</button>
      <button type="button" class="cancel-btn" onclick="closeAddressModal()">Cancel</button>
    </form>
  </div>

  <script>
    // State Variables
    let cart = [];
    let total = 0;
    let ALL_SHOPS = [];
    let CATEGORY = '';
    let USER_LAT = null;
    let USER_LNG = null;
    let SELECTED_PAYMENT = null;
    let CURRENT_SHOP = null;

    /***** Utility *****/
    function escapeHtml(text) {
      var map = {'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;'};
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    /***** Location detection *****/
    function detectLocation() {
      const locEl = document.getElementById('location-text');
      locEl.innerText = 'Detecting your location...';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            USER_LAT = pos.coords.latitude;
            USER_LNG = pos.coords.longitude;
            locEl.innerText = `Lat: ${USER_LAT.toFixed(4)}, Lng: ${USER_LNG.toFixed(4)}`;
            loadShops(CATEGORY);
          },
          () => {
            locEl.innerText = 'Location unavailable';
            USER_LAT = USER_LNG = null;
            loadShops(CATEGORY);
          }
        );
      } else {
        locEl.innerText = 'Geolocation not supported';
        USER_LAT = USER_LNG = null;
        loadShops(CATEGORY);
      }
    }

    /***** Load shops *****/
    function loadShops(category='') {
      let url = '/customer/shops';
      const params = [];
      if (category) params.push('category='+encodeURIComponent(category));
      if (USER_LAT !== null && USER_LNG !== null) {
        params.push('lat='+encodeURIComponent(USER_LAT));
        params.push('lng='+encodeURIComponent(USER_LNG));
      }
      if (params.length) url += '?' + params.join('&');

      fetch(url).then(res => res.json()).then(shops => {
        ALL_SHOPS = shops;
        displayShops(shops);
      }).catch(e => {
        document.getElementById('store-list').innerHTML = "<div style='color:#ea7a7a;text-align:center;width:100%;margin-top:50px;'>Failed to load shops.</div>";
        ALL_SHOPS = [];
      });
    }

    /***** Display shops *****/
    function displayShops(shops) {
      const container = document.getElementById('store-list');
      const itemsList = document.getElementById('items-list');
      container.style.display = 'flex';
      itemsList.style.display = 'none';
      document.getElementById('my-orders-list').style.display = 'none';

      container.innerHTML = '';
      if(!shops.length) {
        container.innerHTML = '<div style="color:white;text-align:center;width:100%;margin-top:60px;">No shops found.</div>';
        return;
      }
      shops.forEach(shop => {
        const div = document.createElement('div');
        div.className = 'store-card';
        div.title = shop.shop_name || 'Shop';

        const categoryText = shop.shop_type === 'grocery' ? 'Grocery' : shop.shop_type === 'medicine' ? 'Medicine' : shop.shop_type === 'food-item' ? 'Restaurant' : 'Other';

        let matchedProductsHTML = '';
        if (shop.matching_products && shop.matching_products.length) {
          matchedProductsHTML = `<div class="matched-products"><b>Matched products:</b> ${shop.matching_products.map(escapeHtml).join(', ')}</div>`;
        }

        div.innerHTML = `
          <span class="category-badge">${escapeHtml(categoryText)}</span>
          <img src="${escapeHtml(shop.shop_photo || '/static/default-avatar.png')}" alt="Shop Photo" />
          <h3>${escapeHtml(shop.shop_name || 'Unnamed Shop')}</h3>
          <div class="contact-small">${escapeHtml(shop.shop_contact || '')}</div>
          <div class="location-small">${escapeHtml(shop.shop_address || '')}</div>
          ${typeof shop.distance_km === 'number' ? `<div style="color:#ace9ff;font-size:13px;margin-top:3px;">Distance: ${shop.distance_km.toFixed(2)} km</div>` : ''}
          ${matchedProductsHTML}
        `;

        div.onclick = () => openModal(shop);

        container.appendChild(div);
      });
    }

    /***** Open product modal *****/
    function openModal(shop) {
      CURRENT_SHOP = shop;
      const modal = document.getElementById('modal');
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
      document.getElementById('modal-title').innerText = shop.shop_name || 'Shop';
      document.getElementById('modal-shop-info').innerText = `${shop.shop_address || ''} | ${shop.shop_contact || ''}`;

      const productList = document.getElementById('product-list');
      productList.innerHTML = '<li>Loading products...</li>';

      fetch(`/customer/products/${encodeURIComponent(shop.email)}`)
        .then(res => res.json())
        .then(products => {
          if(!products.length) {
            productList.innerHTML = '<li>No products available.</li>';
            return;
          }
          productList.innerHTML = '';
          products.forEach(p => {
            const li = document.createElement('li');
            li.style.marginBottom = '12px';
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.fontWeight = '500';

            li.innerHTML = `
              <span>${escapeHtml(p.name)} (${escapeHtml(p.type)})</span>
              <span>₹${p.price.toFixed(2)}</span>
              <button class="add-cart-btn" onclick="event.stopPropagation(); addToCart('${escapeHtml(p.name)}', ${p.price.toFixed(2)})">Add to Cart</button>
            `;
            productList.appendChild(li);
          });
        })
        .catch(() => {
          productList.innerHTML = '<li>Failed to load products.</li>';
        });

      updateTotalPrice();
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    /***** Cart Functions *****/
    function addToCart(name, price) {
      cart.push({ name, price: parseFloat(price) });
      updateTotalPrice();
      updateCartCount();
      alert(`Added "${name}" to cart.`);
    }

    function updateTotalPrice() {
      total = cart.reduce((acc, item) => acc + item.price, 0);
      document.getElementById('total-price').innerText = `Total: ₹${total.toFixed(2)}`;
    }

    function updateCartCount() {
      document.getElementById('cart-count').innerText = cart.length;
    }

    /***** Cart modal *****/
    function showCartModal() {
      if(cart.length === 0) {
        alert('Your cart is empty.');
        return;
      }
      // Hide other sections
      document.getElementById('store-list').style.display = 'none';
      document.getElementById('items-list').style.display = 'none';
      document.getElementById('my-orders-list').style.display = 'none';

      document.getElementById('cartModal').style.display = 'block';
      document.getElementById('cartModal').setAttribute('aria-hidden', 'false');
      populateCartModal();
    }

    function closeCartModal() {
      document.getElementById('cartModal').style.display = 'none';
      document.getElementById('cartModal').setAttribute('aria-hidden', 'true');
    }

    function populateCartModal(){
      const ul = document.getElementById('cart-items');
      let counts = {};
      cart.forEach(item => {
        counts[item.name] = counts[item.name] ? {qty: counts[item.name].qty + 1, price: item.price} : {qty: 1, price: item.price};
      });

      ul.innerHTML = '';
      let cartTotal = 0;
      for(const name in counts){
        const qty = counts[name].qty;
        const price = counts[name].price;
        const subtotal = price * qty;
        cartTotal += subtotal;

        const li = document.createElement('li');
        li.innerHTML = `
          <span>${escapeHtml(name)} x${qty}</span>
          <span>₹${subtotal.toFixed(2)}</span>
          <button type="button" onclick="removeFromCart('${escapeHtml(name)}')" aria-label="Remove ${escapeHtml(name)} from cart">&times;</button>
        `;
        ul.appendChild(li);
      }
      document.getElementById('cart-total').innerText = `Total: ₹${cartTotal.toFixed(2)}`;
      document.getElementById('place-order-btn').disabled = false;
      SELECTED_PAYMENT = null;
      highlightSelectedPayment();
    }

    function removeFromCart(name){
      const idx = cart.findIndex(item => item.name === name);
      if(idx !== -1){
        cart.splice(idx,1);
        populateCartModal();
        updateCartCount();
        updateTotalPrice();
      }
    }

    /***** Payment selection *****/
    function selectPayment(mode){
      SELECTED_PAYMENT = mode;
      highlightSelectedPayment();

      if(mode === 'online') alert('PAY WHEN OUR DELIVERY PERSON REACH YOUR DESTINATION');
    }

    function highlightSelectedPayment(){
      const onBtn = document.getElementById('pay-online-btn');
      const offBtn = document.getElementById('pay-offline-btn');
      if(SELECTED_PAYMENT === 'online'){
        onBtn.style.boxShadow = '0 0 0 3px #8EC5FC';
        offBtn.style.boxShadow = '';
      } else if(SELECTED_PAYMENT === 'offline'){
        offBtn.style.boxShadow = '0 0 0 3px #ffdfa6';
        onBtn.style.boxShadow = '';
      } else {
        onBtn.style.boxShadow = '';
        offBtn.style.boxShadow = '';
      }
    }

    /***** Address modal *****/
    function openAddressModal(){
      if(!SELECTED_PAYMENT){
        alert('Please select a payment mode first.');
        return;
      }
      closeCartModal();
      document.getElementById('addressForm').reset();
      document.getElementsByName('paymentMode').forEach(r => r.checked = false);
      // Check the selected payment mode radio
      const radios = document.getElementsByName('paymentMode');
      radios.forEach(radio => {
        if(radio.value === SELECTED_PAYMENT) radio.checked = true;
      });
      document.getElementById('addressModal').style.display = 'block';
      document.getElementById('addressModal').setAttribute('aria-hidden', 'false');
    }

    function closeAddressModal(){
      document.getElementById('addressModal').style.display = 'none';
      document.getElementById('addressModal').setAttribute('aria-hidden', 'true');
    }

    /***** Submit order *****/
    function submitOrder(event){
      event.preventDefault();
      const form = event.target;
      const custName = form.custName.value.trim();
      const whatsappNum = form.whatsappNum.value.trim();
      const phoneNum = form.phoneNum.value.trim();
      const emailAddr = form.emailAddr.value.trim();
      const custAddr = form.custAddr.value.trim();
      const paymentMode = form.paymentMode.value;

      if(!custName || !whatsappNum || !phoneNum || !emailAddr || !custAddr || !paymentMode){
        alert('Please fill all the required fields.');
        return;
      }
      if(cart.length === 0){
        alert('Your cart is empty.');
        closeAddressModal();
        return;
      }

      const order = {
        shop_email: CURRENT_SHOP ? CURRENT_SHOP.email : '',
        shop_name: CURRENT_SHOP ? CURRENT_SHOP.shop_name : '',
        items: cart,
        total: cart.reduce((sum, item) => sum + item.price, 0),
        payment_mode: paymentMode,
        payment_status: 'paid', // immediate payment status for online or COD
        name: custName,
        whatsapp: whatsappNum,
        phone: phoneNum,
        email: emailAddr,
        address: custAddr,
        lat: USER_LAT,
        lng: USER_LNG,
      };

      fetch('/customer/place-order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(order)
      }).then(res => res.json())
        .then(data => {
          alert(data.message || 'Order placed successfully! Thank you.');
          cart = [];
          updateCartCount();
          updateTotalPrice();
          closeAddressModal();
          closeModal();
          closeCartModal();
          // Optionally refresh or load My Orders modal here
          showMyOrders();
        }).catch(() => alert('Failed to place order, please try again.'));
    }

    /***** My Orders modal (simple implementation) *****/
    function showMyOrders(){
      // Hide shops and items
      document.getElementById('store-list').style.display = 'none';
      document.getElementById('items-list').style.display = 'none';
      document.getElementById('cartModal').style.display = 'none';
      document.getElementById('addressModal').style.display = 'none';
      document.getElementById('modal').style.display = 'none';

      const myOrdersSection = document.getElementById('my-orders-list');
      myOrdersSection.style.display = 'block';
      const contentDiv = document.getElementById('my-orders-content');
      contentDiv.innerHTML = '<p>Loading orders...</p>';

      fetch('/customer/my-orders')
        .then(res => res.text())
        .then(html => {
          // Render server-side rendered orders page into div
          contentDiv.innerHTML = html;
        })
        .catch(() => {
          contentDiv.innerHTML = '<p>Failed to load your orders.</p>';
        });
    }
    function closeMyOrders(){
      document.getElementById('my-orders-list').style.display = 'none';
      // Show shops again
      document.getElementById('store-list').style.display = 'flex';
    }


    /***** Initialization *****/
    window.onload = () => {
      CATEGORY = '';
      detectLocation();
      updateCartCount();
      updateTotalPrice();
    };
  </script>
</body>
</html>
