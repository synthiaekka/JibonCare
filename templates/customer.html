<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HaatXpress Customer - Search, Store & Cart</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      color: #3a1a0c;
      user-select: none;
    }
    header {
      background-color: #5C3A21;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      flex-wrap: wrap;
      gap: 12px;
      user-select: none;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .logo img {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      user-select: none;
    }
    .location {
      font-size: 1rem;
      color: #FFD366;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .location i { color: #d81ba0; }
    .assam-location-select {
      font-size: 1rem;
      padding: 4.5px 12px;
      border-radius: 7px;
      border: 1.5px solid #d81ba0;
      color: #5c3a21;
      background: #fffdf5;
      font-weight: 600;
      min-width: 170px;
      outline: none;
      margin-left: 6px;
    }
    .assam-location-select:focus {
      border: 1.5px solid #7f58e7;
      background: #fbe9f5;
    }
    nav.nav-main {
      display: flex; align-items: center;
      gap: 30px; flex-wrap: wrap; flex: 1;
      justify-content: center;
      font-weight: 600; font-size: 1.1em; user-select: none;
    }
    nav.nav-main a {
      color: white; background: transparent;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    nav.nav-main a:hover, nav.nav-main a:focus {
      background-color: #7f58e7;
      outline: none; color: white;
    }
    select.category-dropdown {
      border-radius: 10px;
      padding: 7px 16px;
      font-size: 16px;
      background: #ede2fc;
      color: #522c54;
      border: none;
      box-shadow: 0 4px 18px #7b1fa22c, 0 1.5px 0 rgba(11, 5, 5, 0.267);
      font-weight: 500;
      outline: none;
      cursor: pointer;
      user-select: none;
    }
    select.category-dropdown:focus {
      box-shadow: 0 0 0 3px #d81ba088;
    }
    .search-bar {
      display: flex; align-items: center;
      gap: 0px; flex-wrap: nowrap;
      border-radius:8px;
      overflow: hidden;
      border: 1.5px solid #f2c5e6;
      background: #ffeefc;
      margin-left: 8px;
    }
    .search-bar input {
      padding: 9px 14px;
      border: none;
      font-size: 15px;
      min-width: 200px;
      outline: none;
      background: transparent;
      color: #5C3A21;
    }
    .search-bar button {
      padding: 8.5px 15px;
      background-color: #D81BA0;
      color: #fff;
      border: none;
      border-radius: 0 7px 7px 0;
      cursor: pointer;
      transition: background 0.18s;
      font-weight: 700;
      font-size: 1em;
    }
    .search-bar button:hover { background: #7f58e7; }
    main { background: #fff; }
    .store-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 30px 12px;
      gap: 24px;
      max-width: 1000px;
      margin: 0 auto;
      user-select: none;
      background: #fff;
    }
    .store-card {
      background-color: #fff3fc;
      color: #491f34;
      padding: 20px;
      border-radius: 14px;
      width: 260px;
      cursor: pointer;
      transition: transform 0.22s, background-color 0.22s;
      border: 1.5px solid #d81ba0;
      text-align: center;
      user-select: none;
      box-shadow: 0 5px 18px #edbbe644;
    }
    .store-card:hover {
      background-color: #f5e0f8;
      transform: translateY(-6px) scale(1.03);
      border-color: #ae3caa;
    }
    .store-card img {
      width: 64px; height: 64px;
      margin: 8px auto 14px auto; display: block;
      border-radius: 10px; object-fit: cover;
      box-shadow: 0 2px 14px #dab0ef33;
    }
    .category-badge {
      display: inline-block; border-radius: 8px;
      font-size: 13px; color: #fff;
      background: #d81ba0;
      padding: 2.3px 10px;
      margin-bottom: 7px; font-weight: 600;
      box-shadow: 0 1.2px 0 #e9a1ea;
    }
    .matched-products {
      margin-top: 8px;
      color: #b32b8d; font-size: 13px;
      font-style: italic;
    }
    .location-small {
      font-size: 13px; color: #835374;
      margin-top: 4px; min-height: 41px;
    }
    .contact-small { font-size: 13px; color: #c34290; margin-bottom: 8px;}
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 10vh;
      left: 50%;
      transform: translateX(-50%);
      width: 92vw;
      max-width: 460px;
      background: #fff6fd;
      border-radius: 24px;
      padding: 40px 36px 25px 36px;
      color: #572760;
      z-index: 10000;
      box-shadow: 0 8px 35px rgba(218,52,185,0.07);
      max-height: 80vh;
      overflow-y: auto;
      user-select: none;
      border: 1.2px solid #d81ba0;
    }
    .modal.active {
      display: block;
    }
    .modal-close {
      background: #d81ba0;
      border: none;
      color: white;
      padding: 7px 19px;
      border-radius: 9px;
      font-weight: 600;
      position: absolute;
      top: 18px;
      right: 20px;
      cursor: pointer;
      user-select: none;
      font-size: 1em;
      transition: background .13s;
    }
    .modal-close:hover { background: #7f58e7; }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .modal li, .product-list-modal li {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      color: #51173a;
      background: #f8eafd;
      border-radius: 7px;
      padding: 7px 12px;
    }
    .add-cart-btn {
      background: #D81BA0;
      border: none;
      padding: 6px 19px;
      color: #fff;
      border-radius: 9px;
      font-weight: 600;
      font-size: 0.97em;
      cursor: pointer;
      transition: background 0.16s;
      user-select: none;
    }
    .add-cart-btn:hover { background: #7f58e7; }
    #total-price {
      text-align: right;
      font-weight: bold;
      margin-top: 16px;
      font-size: 1.1em;
      user-select: none;
      color: #ae299c;
    }
    #cartModal { max-width: 520px;}
    #cartModal h3 { margin-top: 0; margin-bottom: 20px; }
    #cart-items li {
      display: flex;
      justify-content: space-between; align-items: center;
      background: #edd0f5;
      color: #421b4c;
      padding: 10px 15px; margin-bottom: 12px;
      border-radius: 10px; font-weight: 500; user-select: none;
    }
    #cart-items li button {
      background: #D81BA0; border: none; color: white;
      padding: 4px 11px; border-radius: 7px; cursor: pointer;
      font-weight: bold; margin-left: 12px; transition: background 0.17s; user-select: none;
    }
    #cart-items li button:hover { background: #7f58e7; }
    #cart-total {
      font-weight: bold; font-size: 1.2em;
      text-align: right; margin-top: 15px;
      color: #ae44c2;
    }
    #cart-actions { margin-top: 25px; display: flex; justify-content: space-between;}
    #cart-actions button {
      flex: 1; margin: 0 6px; padding: 12px 0;
      font-weight: bold; font-size: 1em; border: none;
      border-radius: 10px; cursor: pointer; transition: background-color 0.2s; user-select: none;
      background: #f8d5f7; color: #af0073;
    }
    #pay-online-btn {background: #D81BA0; color: #fff;}
    #pay-offline-btn {background: #fff7e8; color: #5C3A21;}
    #pay-online-btn:hover, #pay-offline-btn:hover { filter: brightness(0.96);}
    #place-order-btn {
      margin-top: 20px; width: 100%; padding: 14px 0;
      background: #D81BA0; color: #fff; font-weight: 700;
      font-size: 1.1em; border: none; border-radius: 12px;
      cursor: pointer; transition: background-color 0.23s;
    }
    #place-order-btn:disabled { background: #eee; cursor: not-allowed; color: #a4a4a6;}
    #addressModal { max-width: 480px;}
    #addressModal h3 { margin-top: 0; margin-bottom: 20px; font-weight: 700; user-select: none; }
    #addressForm label { font-weight: 600; margin-top: 12px; display: block; user-select: none;}
    #addressForm input, #addressForm textarea {
      width: 100%; padding: 8px 11px; margin-top: 4px; margin-bottom: 12px;
      border-radius: 8px; border: 1.2px solid #debaef; font-size: 1em; font-family: inherit;
      box-sizing: border-box; resize: vertical; user-select: text; color: #35203b;
      background: #fceffd;
    }
    #addressForm textarea { min-height: 55px;}
    #addressForm button { margin-top: 13px; padding: 10px 19px;
      font-weight: 700; font-size: 1em; border-radius: 10px; border: none; cursor: pointer; transition: background-color 0.22s;
      font-family: 'Poppins', sans-serif; user-select: none;
    }
    #addressForm button.submit-btn { background-color: #D81BA0; color: white; margin-right: 12px;}
    #addressForm button.cancel-btn { background-color: #c0392b; color: white;}
    @media (max-width:700px){
      body {background:#fff;}
      .store-section {flex-direction: column;}
      .store-card {width: 97vw;}
      header { flex-direction: column;}
      main {padding-bottom:36px;}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/static/images/jiboncare_Logo.png" alt="HaatXpress Logo" />
      <div class="location" id="location-wrapper">
        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
        <select id="location-select" class="assam-location-select" onchange="handleLocationChange()" aria-label="Choose Assam location">
          <option value="">Select Area, Town or District</option>
          <optgroup label="Kamrup Metro">
            <option value="Guwahati">Guwahati</option>
            <option value="Khanapara">Khanapara</option>
            <option value="Maligaon">Maligaon</option>
            <option value="Beltola">Beltola</option>
          </optgroup>
          <optgroup label="Dibrugarh">
            <option value="Dibrugarh">Dibrugarh Town</option>
            <option value="Chabua">Chabua</option>
            <option value="Naharkatia">Naharkatia</option>
          </optgroup>
          <optgroup label="Jorhat">
            <option value="Jorhat">Jorhat Town</option>
            <option value="Teok">Teok</option>
            <option value="Titabor">Titabor</option>
          </optgroup>
          <optgroup label="Cachar">
            <option value="Silchar">Silchar</option>
            <option value="Katigorah">Katigorah</option>
          </optgroup>
          <optgroup label="Barpeta">
            <option value="Barpeta">Barpeta</option>
            <option value="Howly">Howly</option>
            <option value="Pathsala">Pathsala</option>
          </optgroup>
          <optgroup label="Sonitpur">
            <option value="Tezpur">Tezpur</option>
            <option value="Biswanath">Biswanath Chariali</option>
          </optgroup>
          <optgroup label="Other">
            <option value="Tinsukia">Tinsukia</option>
            <option value="Sibsagar">Sibsagar</option>
            <option value="Nagaon">Nagaon</option>
            <option value="Mangaldoi">Mangaldoi</option>
            <option value="Goalpara">Goalpara</option>
            <option value="Dhemaji">Dhemaji</option>
            <option value="Lakhimpur">Lakhimpur</option>
            <option value="Dhubri">Dhubri</option>
            <option value="Bongaigaon">Bongaigaon</option>
          </optgroup>
        </select>
      </div>
    </div>
    <nav class="nav-main" aria-label="Main navigation">
      <a href="/" tabindex="0">Home</a>
      <a href="/about" tabindex="0">About</a>
      <a href="#" onclick="showMyOrders()" tabindex="0">My Orders</a>
      <a href="#" onclick="showCartModal()" tabindex="0">Cart (<span id="cart-count" aria-live="polite" aria-atomic="true">0</span>)</a>
    </nav>
    <select id="catSelect" class="category-dropdown" onchange="categoryChanged()" aria-label="Select category">
      <option value="">All Categories</option>
      <option value="grocery">Grocery</option>
      <option value="medicine">Medicine</option>
      <option value="food-item">Restaurant</option>
    </select>
    <div class="search-bar">
      <input
        id="searchInput"
        type="text"
        placeholder="Search store, product or location..."
        onkeyup="liveFilterShop()"
        autocomplete="off"
        aria-label="Search store, product or location"
      />
      <button onclick="liveFilterShop()" aria-label="Search">
        <i class="fas fa-search" aria-hidden="true"></i>
      </button>
    </div>
  </header>

  <main>
    <section class="store-section" id="store-list" aria-label="List of shops">
      <div style="width: 100%; text-align: center; margin-top: 80px; font-size: 1.2em; color: #b121a5;">
        Please select your location to see shops.
      </div>
    </section>
    <section class="store-section" id="items-list" aria-label="Items for selected shop" style="display:none;">
      <h2 id="items-list-title" style="width:100%; text-align:center; margin-bottom: 24px;"></h2>
    </section>
    <section class="store-section" id="my-orders-list" aria-label="My orders" style="display:none; max-width: 600px; margin: 30px auto; color: #6d3367;">
      <h2 style="width: 100%; text-align: center; margin-bottom: 20px;">My Orders</h2>
      <div id="my-orders-content" style="font-size: 1em;"></div>
      <button onclick="closeMyOrders()" style="margin: 20px auto; display: block; padding: 10px 20px; font-weight: 600; border-radius: 8px; border:none; background: #D81BA0; color: white; cursor: pointer;">Close Orders</button>
    </section>
  </main>

  <!-- PRODUCT MODAL -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
    <button class="modal-close" aria-label="Close product modal" onclick="closeModal()">Close</button>
    <h2 id="modal-title">Store Name</h2>
    <div class="shop-info" id="modal-shop-info" style="margin-bottom:10px;"></div>
    <ul id="product-list"></ul>
    <div id="total-price">Total: ₹0</div>
  </div>

  <!-- CART MODAL -->
  <div id="cartModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cartModalTitle" tabindex="-1">
    <button class="modal-close" aria-label="Close cart modal" onclick="closeCartModal()">Close</button>
    <h3 id="cartModalTitle">Your Cart</h3>
    <ul id="cart-items"></ul>
    <div id="cart-total">Total: ₹0</div>
    <div id="cart-actions">
      <button id="pay-online-btn" onclick="selectPayment('online')" type="button">Pay Online</button>
      <button id="pay-offline-btn" onclick="selectPayment('offline')" type="button">Cash on Delivery (COD)</button>
    </div>
    <button id="place-order-btn" disabled onclick="openAddressModal()">Place Order</button>
  </div>

  <!-- ADDRESS MODAL -->
  <div id="addressModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addressModalTitle" tabindex="-1">
    <button class="modal-close" aria-label="Close address modal" onclick="closeAddressModal()">Close</button>
    <h3 id="addressModalTitle">Delivery Details</h3>
    <form id="addressForm" onsubmit="submitOrder(event)">
      <label for="custName">Name:</label>
      <input type="text" id="custName" name="custName" required autocomplete="name" />
      <label for="whatsappNum">WhatsApp Number:</label>
      <input type="tel" id="whatsappNum" name="whatsappNum" placeholder="10 digit number" pattern="[0-9]{10}" required autocomplete="tel"/>
      <label for="phoneNum">Phone Number:</label>
      <input type="tel" id="phoneNum" name="phoneNum" placeholder="10 digit number" pattern="[0-9]{10}" required autocomplete="tel"/>
      <label for="emailAddr">Email:</label>
      <input type="email" id="emailAddr" name="emailAddr" required autocomplete="email"/>
      <label for="custAddr">Delivery Address:</label>
      <textarea id="custAddr" name="custAddr" required></textarea>
      <label>Payment Mode:</label>
      <div style="margin-bottom: 14px;">
        <label><input type="radio" name="paymentMode" value="online" required /> Online Payment</label><br />
        <label><input type="radio" name="paymentMode" value="offline" /> Cash on Delivery (COD)</label>
      </div>
      <button type="submit" class="submit-btn">Submit Order</button>
      <button type="button" class="cancel-btn" onclick="closeAddressModal()">Cancel</button>
    </form>
  </div>

  <script>
    let cart = [];
    let total = 0;
    let ALL_SHOPS = [];
    let ALL_ITEMS_BY_SHOP = {};
    let CATEGORY = '';
    let SELECTED_PAYMENT = null;
    let CURRENT_SHOP = null;
    let USER_LOCATION = '';

    // Handle Assam location dropdown
    function handleLocationChange() {
      const select = document.getElementById('location-select');
      USER_LOCATION = select.value;
      if (!USER_LOCATION) {
        document.getElementById('store-list').innerHTML =
          "<div style='width:100%;text-align:center;margin-top:80px;font-size:1.2em;color:#b121a5;'>Please select your location to see shops.</div>";
        ALL_SHOPS = [];
        return;
      }
      // Save in localStorage (optional)
      try { localStorage.setItem('hx_selected_area', USER_LOCATION); } catch(e){}
      // Load shops for this location
      loadShops(CATEGORY, USER_LOCATION);
    }

    // Restore selected location on reload
    window.onload = function() {
      // Restore place, if saved
      const prevLoc = localStorage.getItem('hx_selected_area') || '';
      if (prevLoc && document.getElementById('location-select')) {
        document.getElementById('location-select').value = prevLoc;
        USER_LOCATION = prevLoc;
      }
      updateCartCount();
      updateTotalPrice();
      if (USER_LOCATION) loadShops('', USER_LOCATION);
    };

    // Load shops for district/town and (optionally) category
    function loadShops(category = '', area = '') {
      let url = '/customer/shops';
      const params = [];
      if (category) params.push('category=' + encodeURIComponent(category));
      if (area) params.push('area=' + encodeURIComponent(area));
      if (params.length) url += '?' + params.join('&');

      document.getElementById('store-list').innerHTML =
        "<div style='width:100%;text-align:center;margin-top:80px;font-size:1.2em;'>Loading shops...</div>";
      ALL_ITEMS_BY_SHOP = {};
      fetch(url)
        .then(res => res.json())
        .then(shops => {
          ALL_SHOPS = shops;
          // Pre-fetch products for smart search
          let proms = [];
          shops.forEach(shop => {
            if (shop && shop.email) {
              proms.push(
                fetch(`/customer/products/${encodeURIComponent(shop.email)}`)
                  .then(r => r.ok ? r.json() : [])
                  .then(arr => { ALL_ITEMS_BY_SHOP[shop.email] = arr || []; })
              );
            }
          });
          Promise.all(proms).then(() => {
            displayShops(shops);
          });
        }).catch(e => {
          document.getElementById('store-list').innerHTML =
            "<div style='color:#ea7a7a;text-align:center;width:100%;margin-top:50px;'>Failed to load shops.</div>";
          ALL_SHOPS = [];
        });
    }

    function displayShops(shops) {
      const container = document.getElementById('store-list');
      const itemsList = document.getElementById('items-list');
      container.style.display = 'flex';
      itemsList.style.display = 'none';
      document.getElementById('my-orders-list').style.display = 'none';

      container.innerHTML = '';
      if (!shops.length) {
        container.innerHTML = '<div style="color:#d81ba0;text-align:center;width:100%;margin-top:60px;">No shops found.</div>';
        return;
      }
      shops.forEach(shop => {
        const div = document.createElement('div');
        div.className = 'store-card';
        div.title = shop.shop_name || 'Shop';
        const catTxt = shop.shop_type === 'grocery' ? 'Grocery'
          : shop.shop_type === 'medicine' ? 'Medicine'
          : shop.shop_type === 'food-item' ? 'Restaurant'
          : 'Other';
        let matchedProductsHTML = '';
        if (shop.matching_products && shop.matching_products.length) {
          matchedProductsHTML = `<div class="matched-products"><b>Matched products:</b> ${shop.matching_products.map(escapeHtml).join(', ')}</div>`;
        }
        div.innerHTML = `
          <span class="category-badge">${escapeHtml(catTxt)}</span>
          <img src="${escapeHtml(shop.shop_photo || '/static/default-avatar.png')}" alt="Shop Photo" />
          <h3>${escapeHtml(shop.shop_name || 'Unnamed Shop')}</h3>
          <div class="contact-small">${escapeHtml(shop.shop_contact || '')}</div>
          <div class="location-small">${escapeHtml(shop.shop_address || '')}</div>
          ${typeof shop.distance_km === 'number' ? `<div style="color:#ae299c;font-size:13px;margin-top:3px;">Distance: ${shop.distance_km.toFixed(2)} km</div>` : ''}
          ${matchedProductsHTML}`;
        div.onclick = () => openModal(shop);
        container.appendChild(div);
      });
    }

    function categoryChanged() {
      CATEGORY = document.getElementById('catSelect').value;
      liveFilterShop();
    }
    function escapeHtml(text) {
      var map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
      return text.replace(/[&<>"']/g, m => map[m]);
    }
    function liveFilterShop() {
      const value = document.getElementById('searchInput').value.trim().toLowerCase();
      let filtered = ALL_SHOPS.slice();
      // Filter by category if selected
      if (CATEGORY) {
        filtered = filtered.filter(shop => shop.shop_type === CATEGORY);
      }
      if (value.length > 0) {
        filtered = filtered.filter(shop => {
          const shopName = (shop.shop_name || '').toLowerCase();
          const address = (shop.shop_address || '').toLowerCase();
          const contact = (shop.shop_contact || '').toLowerCase();
          let matchesProduct = false;
          const plist = ALL_ITEMS_BY_SHOP[shop.email];
          if (plist && plist.length) {
            for (let p of plist) {
              if ((p.name || '').toLowerCase().includes(value)) {
                matchesProduct = true;
                break;
              }
            }
          }
          return shopName.includes(value)
            || address.includes(value)
            || contact.includes(value)
            || matchesProduct;
        });
      }
      displayShops(filtered);
    }

    function openModal(shop) {
      CURRENT_SHOP = shop;
      const modal = document.getElementById('modal');
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
      document.getElementById('modal-title').innerText = shop.shop_name || 'Shop';
      document.getElementById('modal-shop-info').innerText = `${shop.shop_address || ''} | ${shop.shop_contact || ''}`;
      const productList = document.getElementById('product-list');
      productList.innerHTML = '<li>Loading products...</li>';
      fetch(`/customer/products/${encodeURIComponent(shop.email)}`)
        .then(res => res.json())
        .then(products => {
          if(!products.length) {
            productList.innerHTML = '<li>No products available.</li>';
            return;
          }
          productList.innerHTML = '';
          products.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `
              <span>${escapeHtml(p.name)} (${escapeHtml(p.type)})</span>
              <span>₹${p.price.toFixed(2)}</span>
              <button class="add-cart-btn" onclick="event.stopPropagation(); addToCart('${escapeHtml(p.name)}', ${p.price.toFixed(2)})">Add to Cart</button>
            `;
            productList.appendChild(li);
          });
        })
        .catch(() => {
          productList.innerHTML = '<li>Failed to load products.</li>';
        });
      updateTotalPrice();
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }
    function addToCart(name, price) {
      cart.push({ name, price: parseFloat(price) });
      updateTotalPrice();
      updateCartCount();
      alert(`Added "${name}" to cart.`);
    }
    function updateTotalPrice() {
      total = cart.reduce((acc, item) => acc + item.price, 0);
      document.getElementById('total-price').innerText = `Total: ₹${total.toFixed(2)}`;
    }
    function updateCartCount() {
      document.getElementById('cart-count').innerText = cart.length;
    }
    function showCartModal() {
      if(cart.length === 0) {
        alert('Your cart is empty.');
        return;
      }
      document.getElementById('store-list').style.display = 'none';
      document.getElementById('items-list').style.display = 'none';
      document.getElementById('my-orders-list').style.display = 'none';
      document.getElementById('cartModal').style.display = 'block';
      document.getElementById('cartModal').setAttribute('aria-hidden', 'false');
      populateCartModal();
    }
    function closeCartModal() {
      document.getElementById('cartModal').style.display = 'none';
      document.getElementById('cartModal').setAttribute('aria-hidden', 'true');
    }
    function populateCartModal(){
      const ul = document.getElementById('cart-items');
      let counts = {};
      cart.forEach(item => {
        counts[item.name] = counts[item.name] ? {qty: counts[item.name].qty + 1, price: item.price} : {qty: 1, price: item.price};
      });
      ul.innerHTML = '';
      let cartTotal = 0;
      for(const name in counts){
        const qty = counts[name].qty;
        const price = counts[name].price;
        const subtotal = price * qty;
        cartTotal += subtotal;
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${escapeHtml(name)} x${qty}</span>
          <span>₹${subtotal.toFixed(2)}</span>
          <button type="button" onclick="removeFromCart('${escapeHtml(name)}')" aria-label="Remove ${escapeHtml(name)} from cart">&times;</button>
        `;
        ul.appendChild(li);
      }
      document.getElementById('cart-total').innerText = `Total: ₹${cartTotal.toFixed(2)}`;
      document.getElementById('place-order-btn').disabled = cartTotal === 0;
      SELECTED_PAYMENT = null;
      highlightSelectedPayment();
    }
    function removeFromCart(name){
      const idx = cart.findIndex(item => item.name === name);
      if(idx !== -1){
        cart.splice(idx,1);
        populateCartModal();
        updateCartCount();
        updateTotalPrice();
      }
    }
    function selectPayment(mode){
      SELECTED_PAYMENT = mode;
      highlightSelectedPayment();
      if(mode === 'online') alert('PAY WHEN OUR DELIVERY PERSON REACH YOUR DESTINATION');
    }
    function highlightSelectedPayment(){
      const onBtn = document.getElementById('pay-online-btn');
      const offBtn = document.getElementById('pay-offline-btn');
      if(SELECTED_PAYMENT === 'online'){
        onBtn.style.boxShadow = '0 0 0 3px #e2b6fd';
        offBtn.style.boxShadow = '';
      } else if(SELECTED_PAYMENT === 'offline'){
        offBtn.style.boxShadow = '0 0 0 3px #fdbee2';
        onBtn.style.boxShadow = '';
      } else {
        onBtn.style.boxShadow = '';
        offBtn.style.boxShadow = '';
      }
    }
    function openAddressModal(){
      if(!SELECTED_PAYMENT){
        alert('Please select a payment mode first.');
        return;
      }
      closeCartModal();
      document.getElementById('addressForm').reset();
      document.getElementsByName('paymentMode').forEach(r => r.checked = false);
      const radios = document.getElementsByName('paymentMode');
      radios.forEach(radio => {
        if(radio.value === SELECTED_PAYMENT) radio.checked = true;
      });
      document.getElementById('addressModal').style.display = 'block';
      document.getElementById('addressModal').setAttribute('aria-hidden', 'false');
    }
    function closeAddressModal(){
      document.getElementById('addressModal').style.display = 'none';
      document.getElementById('addressModal').setAttribute('aria-hidden', 'true');
    }
    function submitOrder(event){
      event.preventDefault();
      const form = event.target;
      const custName = form.custName.value.trim();
      const whatsappNum = form.whatsappNum.value.trim();
      const phoneNum = form.phoneNum.value.trim();
      const emailAddr = form.emailAddr.value.trim();
      const custAddr = form.custAddr.value.trim();
      const paymentMode = form.paymentMode.value;
      if(!custName || !whatsappNum || !phoneNum || !emailAddr || !custAddr || !paymentMode){
        alert('Please fill all the required fields.');
        return;
      }
      if(cart.length === 0){
        alert('Your cart is empty.');
        closeAddressModal();
        return;
      }
      const order = {
        shop_email: CURRENT_SHOP ? CURRENT_SHOP.email : '',
        shop_name: CURRENT_SHOP ? CURRENT_SHOP.shop_name : '',
        items: cart,
        total: cart.reduce((sum, item) => sum + item.price, 0),
        payment_mode: paymentMode,
        payment_status: 'paid',
        name: custName,
        whatsapp: whatsappNum,
        phone: phoneNum,
        email: emailAddr,
        address: custAddr,
        area: USER_LOCATION,
      };
      fetch('/customer/place-order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(order)
      }).then(res => res.json())
        .then(data => {
          alert(data.message || 'Order placed successfully! Thank you.');
          cart = [];
          updateCartCount();
          updateTotalPrice();
          closeAddressModal();
          closeModal();
          closeCartModal();
          showMyOrders();
        }).catch(() => alert('Failed to place order, please try again.'));
    }
    function showMyOrders(){
      document.getElementById('store-list').style.display = 'none';
      document.getElementById('items-list').style.display = 'none';
      document.getElementById('cartModal').style.display = 'none';
      document.getElementById('addressModal').style.display = 'none';
      document.getElementById('modal').style.display = 'none';
      const myOrdersSection = document.getElementById('my-orders-list');
      myOrdersSection.style.display = 'block';
      const contentDiv = document.getElementById('my-orders-content');
      contentDiv.innerHTML = '<p>Loading orders...</p>';
      fetch('/customer/my-orders')
        .then(res => res.text())
        .then(html => { contentDiv.innerHTML = html; })
        .catch(() => { contentDiv.innerHTML = '<p>Failed to load your orders.</p>'; });
    }
    function closeMyOrders(){
      document.getElementById('my-orders-list').style.display = 'none';
      document.getElementById('store-list').style.display = 'flex';
    }
  </script>
</body>
</html>
