<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HaatXpress - Local Shops Delivered</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #fff;
      margin: 0;
      padding: 0;
      color: #443315;
      min-height: 100vh;
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a,
    button {
      user-select: none;
    }
    header {
      background-color: #5c3a21;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      flex-wrap: wrap;
      box-shadow: 0 3px 9px rgba(92, 58, 33, 0.7);
      position: relative;
      z-index: 1000;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo img {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      user-select: none;
    }
    .location {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      color: #ffd366;
    }
    .location i {
      color: #d81ba0;
    }
    .location button#change-location-btn {
      margin-left: 8px;
      background-color: #d81ba0;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .location button#change-location-btn:hover {
      background-color: #7f58e7;
    }
    .nav-main {
      display: flex;
      align-items: center;
      gap: 30px;
      flex: 1;
      justify-content: center;
      user-select: none;
    }
    .category-dropdown {
      border-radius: 10px;
      padding: 7px 16px;
      font-size: 16px;
      background: #f7f0ff;
      color: #5c3a21;
      border: 1.5px solid #d81ba0;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    .category-dropdown:hover,
    .category-dropdown:focus {
      border-color: #7f58e7;
      outline: none;
      box-shadow: 0 0 10px #7f58e7aa;
    }
    .search-bar {
      display: flex;
      align-items: center;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 18px #d81ba020;
    }
    .search-bar input {
      padding: 8px 14px;
      border: none;
      font-size: 14px;
      outline: none;
      min-width: 220px;
      color: #5c3a21;
    }
    .search-bar button {
      padding: 8px 12px;
      background-color: #d81ba0;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
    }
    .search-bar button:hover {
      background-color: #7f58e7;
    }
    .auth-cart {
      display: flex;
      align-items: center;
      gap: 18px;
      position: relative;
      user-select: none;
    }
    .auth-cart a,
    .auth-cart span {
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.05em;
      cursor: pointer;
      padding: 6px 15px;
      border-radius: 6px;
      background: #d81ba0;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .auth-cart a:hover {
      background-color: #7f58e7;
    }
    .auth-cart .fa-shopping-cart {
      color: white !important;
      font-size: 22px;
      position: relative;
    }
    #cart-count {
      position: absolute;
      top: -8px;
      right: -10px;
      background: #7f58e7;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 50%;
      font-weight: bold;
      user-select: none;
    }
    .hero {
      text-align: center;
      color: #5c3a21;
      padding: 60px 20px 38px;
      max-width: 600px;
      margin: 20px auto 40px;
      border-radius: 15px;
      background: #fff0fa;
      box-shadow: 0 0 25px rgba(128, 60, 131, 0.3);
      user-select: none;
    }
    .hero h2 {
      font-size: 2.6rem;
      letter-spacing: 0.2ch;
      margin-bottom: 15px;
      font-weight: 700;
      color: #7f58e7;
    }
    .hero p {
      font-size: 1.15rem;
      color: #6a4f73;
      letter-spacing: 0.02ch;
      line-height: 1.5;
    }
    .store-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 40px 4vw;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto 60px;
      user-select: none;
    }
    .store-card {
      background: #fff0fa;
      color: #5c3a21;
      padding: 22px 14px 20px;
      border-radius: 16px;
      min-width: 240px;
      max-width: 265px;
      box-shadow: 0 6px 12px #b97fc0aa;
      cursor: pointer;
      transition: box-shadow 0.25s, transform 0.21s;
      border: 1px solid #d81ba0;
      text-align: center;
      position: relative;
      user-select: none;
    }
    .store-card:hover {
      background: #e9d6f9;
      box-shadow: 0 14px 36px #7f58e7aa;
      transform: translateY(-6px) scale(1.06);
      border-color: #7f58e7;
    }
    .store-card img {
      width: 72px;
      height: 72px;
      margin: 8px auto 16px auto;
      display: block;
      border-radius: 15px;
      object-fit: cover;
      box-shadow: 0 6px 14px #ae73cdcc;
      user-select: none;
    }
    .store-card h3 {
      margin: 6px 0 8px;
      font-size: 1.2em;
      font-weight: 700;
      color: #5c3a21;
      user-select: text;
    }
    .category-badge {
      display: inline-block;
      border-radius: 9px;
      font-size: 13px;
      color: #4a3052;
      background: #d5c1f7;
      padding: 3px 13px;
      margin-bottom: 9px;
      font-weight: 600;
      box-shadow: 0 1.5px 0 #bfb5f8;
      user-select: none;
    }
    .store-dist {
      font-size: 12px;
      color: #835f9e;
      margin: 4px;
      user-select: none;
    }
    .modal {
      display: none;
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      max-width: 420px;
      min-width: 280px;
      background: #422d4bdd;
      color: #f3eefd;
      border-radius: 16px;
      padding: 36px 34px 28px 34px;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 5px 43px #765097cc;
      user-select: none;
    }
    .modal.active {
      display: block;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-close {
      background: #7f58e7;
      border: none;
      padding: 10px 19px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      transition: background-color 0.25s ease;
    }
    .modal-close:hover {
      background: #d81ba0;
    }
    .modal h2 {
      margin: 0;
      color: #c4a7f9;
      font-weight: 700;
      user-select: none;
    }
    .modal ul {
      margin: 15px 0 0 0;
      padding: 0;
      list-style: none;
      max-height: 50vh;
      overflow-y: auto;
    }
    .modal li {
      margin: 10px 0;
      padding: 7px 14px;
      border-radius: 10px;
      background: #60486c;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2.5px 12px #8f7fc299;
      font-size: 1em;
      user-select: none;
    }
    .modal li .item-info {
      display: flex;
      flex-direction: column;
      max-width: 75%;
    }
    .modal li .item-name {
      font-weight: 700;
      margin-bottom: 3px;
      color: #e5d1f5;
    }
    .modal li .item-desc {
      font-size: 0.85em;
      color: #c9b5de;
    }
    .modal li .item-price {
      font-weight: 700;
      color: #d1adf4;
      margin-right: 10px;
      white-space: nowrap;
      user-select: text;
    }
    .modal li button {
      padding: 6px 14px;
      background: #d81ba0;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
      user-select: none;
      white-space: nowrap;
    }
    .modal li button:hover {
      background: #7f58e7;
    }
    #total-price {
      margin-top: 18px;
      font-size: 1.05em;
      font-weight: 700;
      user-select: none;
      color: #c299f5;
    }
    .login-modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(92, 58, 33, 0.9);
      z-index: 4000;
      text-align: center;
      color: white;
      min-height: 0;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      animation: fadein 0.3s ease-in;
      user-select: none;
    }
    .login-modal.active {
      display: flex;
    }
    @keyframes fadein {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    .login-modal h2 {
      font-size: 1.8em;
      margin-bottom: 14px;
      color: #e1bee7;
      user-select: none;
    }
    .login-modal p {
      font-size: 1.2em;
      margin-bottom: 30px;
      color: #d8b6e1;
      user-select: none;
    }
    .login-modal a {
      background: #d81ba0;
      display: inline-block;
      margin: 0 16px;
      padding: 16px 40px;
      border-radius: 10px;
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.2em;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .login-modal a:hover {
      background: #7f58e7;
    }
    .login-modal button {
      margin-top: 30px;
      padding: 10px 36px;
      border-radius: 8px;
      background: #e74c3c;
      color: white;
      border: none;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .login-modal button:hover {
      background: #bf1e24;
    }
    #locationModal.login-modal.active {
      display: flex !important;
      flex-direction: column;
      background: rgba(92, 58, 33, 0.9);
      z-index: 5000;
      padding: 30px 20px;
    }
    #locationModal h2,
    #locationModal p {
      color: #f5d0fa;
      user-select: none;
    }
    #locationModal input {
      padding: 12px 16px;
      border-radius: 10px;
      width: 80%;
      max-width: 320px;
      font-size: 1em;
      border: 2px solid #d81ba0;
      margin-bottom: 15px;
      outline: none;
      color: #5c3a21;
      font-weight: 700;
      user-select: text;
      transition: border-color 0.3s ease;
    }
    #locationModal input:focus {
      border-color: #7f58e7;
      box-shadow: 0 0 7px #7f58e7cc;
    }
    #locationModal button {
      padding: 12px 32px;
      border-radius: 10px;
      background: #d81ba0;
      color: white;
      font-weight: 700;
      font-size: 1.15em;
      cursor: pointer;
      border: none;
      user-select: none;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 12px #d81baacc;
    }
    #locationModal button:hover {
      background: #7f58e7;
      box-shadow: 0 5px 15px #7f58e7cc;
    }
    @media (max-width: 700px) {
      .store-section {
        flex-direction: column;
        padding: 30px 4vw;
      }
      .store-card {
        width: auto;
        max-width: 100%;
      }
      .modal {
        left: 2vw;
        width: 96vw;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="{{ url_for('static', filename='images/jiboncare_Logo.png') }}" alt="HaatXpress Logo" />
      <div class="location" aria-live="polite" aria-atomic="true">
        <i class="fas fa-map-marker-alt"></i>
        <span id="location-text">Please set your location</span>
      </div>
    </div>
    <div class="nav-main">
      <label for="categorySelect" style="color:#fff;font-weight:600;margin-right:7px;">Select Category:</label>
      <select id="categorySelect" class="category-dropdown" onchange="categoryChanged()" aria-label="Select category">
        <option value="">All</option>
        <option value="grocery">Grocery</option>
        <option value="medicine">Medicine</option>
        <option value="food-item">Restaurant</option>
      </select>
      <div class="search-bar">
        <input
          id="searchInput"
          type="text"
          placeholder="Search store, product or location..."
          onkeyup="triggerSmartSearch()"
          aria-label="Search stores, products or location"
        />
        <button aria-label="Search"><i class="fas fa-search"></i></button>
      </div>
    </div>
    <div class="auth-cart">
      {% if user_email %}
      <span id="user-email" style="color:#FFD366;" aria-label="User email">{{ user_email }}</span>
      <a href="/logout" role="button" aria-label="Logout">Logout</a>
      {% else %}
      <a href="/register" role="button" aria-label="Register">Register</a>
      <a href="/login" role="button" aria-label="Login">Login</a>
      {% endif %}
      <a href="#" role="button" aria-label="Shopping cart">
        <i class="fas fa-shopping-cart" style="position: relative;">
          <span id="cart-count">0</span>
        </i>
      </a>
    </div>
  </header>

  <section class="hero" role="banner">
    <h2>Welcome to HaatXpress</h2>
    <p>
      Connecting you directly to local shops - groceries, medicines, food, all
<<<<<<< HEAD
      from your trusted neighborhood within your zone. Stay happyðŸ˜€â¤
=======
      from your trusted neighborhood within your zone. Stay happyðŸ˜€â¤ï¸
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
    </p>
  </section>

  <section class="store-section" id="store-list" aria-label="List of shops">
    <div style="color:#5C3A21;text-align:center;width:100%;">Please set your location to see shops.</div>
  </section>

  <section class="store-section" id="items-list" aria-label="Items uploaded by selected shop">
    <div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>
  </section>

  <!-- Location Input Modal -->
  <div
    class="modal login-modal active"
    id="locationModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="locationModalTitle"
    tabindex="-1"
  >
    <h2 id="locationModalTitle">Where do you want to order from?</h2>
    <p>Please enter your area, city, or PIN code to see sellers near you.</p>
    <input
      type="text"
      id="user-location-input"
      placeholder="Enter your location"
      aria-label="Enter your location"
    />
    <br />
    <button onclick="submitUserLocation()">Confirm Location</button>
  </div>

  <!-- Login/Register Prompt Modal -->
  <div
    class="login-modal"
    id="loginPromptModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="loginPromptTitle"
    tabindex="-1"
    aria-hidden="true"
  >
    <h2 id="loginPromptTitle">Please Log In / Register</h2>
    <p>You need to be logged in to add items to your cart.</p>
    <a href="/login" role="button" aria-label="Go to Login">Login</a>
    <a href="/register" role="button" aria-label="Go to Register">Register</a>
    <button onclick="closeLoginPrompt()" aria-label="Close">Cancel</button>
  </div>

  <!-- Shop Menu Modal -->
  <div
    class="modal"
    id="menuModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="menuModalTitle"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-header">
      <h2 id="menuModalTitle">Shop Menu</h2>
      <button
        class="modal-close"
        aria-label="Close Menu"
        onclick="closeMenuModal()"
      >
        &times;
      </button>
    </div>
    <div id="menuContent">
      <p>Loading menu...</p>
    </div>
  </div>
<<<<<<< HEAD

=======
<center>
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
  <footer role="contentinfo">
    <p>&copy; 2025 HaatXpress. Made with ðŸ§¡ for your neighborhood.</p>
    <p>
      Contact: <a href="mailto:support@haatexpress.com">support@haatexpress.com</a>
    </p>
  </footer>
</center>
  <script>
    // Variables
    let userLocation = null;
    const isUserLoggedIn = !!document.getElementById("user-email");
    let cartCount = 0;
    let CURRENT_SHOPS = [];
    let CURRENT_CATEGORY = "";
    let SEARCH_TEXT = "";

<<<<<<< HEAD
  <script>
    // Variables
    let userLocation = null;
    const isUserLoggedIn = !!document.getElementById("user-email");
    let cartCount = 0;
    let CURRENT_SHOPS = [];
    let CURRENT_CATEGORY = "";
    let SEARCH_TEXT = "";

=======
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
    // Submit user location
    function submitUserLocation() {
      const input = document.getElementById("user-location-input");
      const location = input.value.trim();
      if (!location) {
        alert("Please enter a valid location.");
        return;
      }
      userLocation = location;
      document.getElementById("locationModal").classList.remove("active");
      updateHeaderLocation();
      fetchShopsByArea(userLocation);
    }

    // Update header location display and button
    function updateHeaderLocation() {
      const locationText = document.getElementById("location-text");
      locationText.textContent = userLocation + " ";
      if (!document.getElementById("change-location-btn")) {
        const locationDiv = locationText.parentElement;
        const btn = document.createElement("button");
        btn.id = "change-location-btn";
        btn.textContent = "Change";
        btn.style.cssText =
          "margin-left:8px; background:#D81BA0; color:#fff; border:none; border-radius:5px; padding:3px 10px; cursor:pointer; font-weight:600;";
        btn.setAttribute("aria-label", "Change your location");
        btn.onmouseenter = () => (btn.style.backgroundColor = "#7f58e7");
        btn.onmouseleave = () => (btn.style.backgroundColor = "#D81BA0");
        btn.onclick = openLocationModal;
        locationDiv.appendChild(btn);
      }
    }
    function openLocationModal() {
      document.getElementById("locationModal").classList.add("active");
      document.getElementById("user-location-input").value = "";
    }

    // Fetch shops by area from API
    function fetchShopsByArea(area) {
      const storeList = document.getElementById("store-list");
<<<<<<< HEAD
      storeList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">Loading shops...</div>;
      fetch(/api/shops?area=${encodeURIComponent(area)})
=======
      storeList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Loading shops...</div>`;
      fetch(`/api/shops?area=${encodeURIComponent(area)}`)
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        .then((response) => {
          if (!response.ok) throw new Error("API error");
          return response.json();
        })
        .then((data) => {
          CURRENT_SHOPS = data.shops || data;
          CURRENT_CATEGORY = "";
          SEARCH_TEXT = "";
          showShops(CURRENT_SHOPS);
          resetFilters();
        })
        .catch(() => {
<<<<<<< HEAD
          storeList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">Error loading shops.</div>;
=======
          storeList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Error loading shops.</div>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        });
    }

    // Show shops in UI
    function showShops(shops) {
      const storeList = document.getElementById("store-list");
      if (!shops || shops.length === 0) {
<<<<<<< HEAD
        storeList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">No shops found in your area.</div>;
=======
        storeList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">No shops found in your area.</div>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        return;
      }
      storeList.innerHTML = "";
      shops.forEach((shop) => {
        const shopElem = document.createElement("div");
        shopElem.className = "store-card";
        shopElem.tabIndex = 0;
        shopElem.setAttribute("role", "region");
<<<<<<< HEAD
        shopElem.setAttribute("aria-label", ${shop.name} shop);
=======
        shopElem.setAttribute("aria-label", `${shop.name} shop`);
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        shopElem.innerHTML = `
          <img src="${shop.image_url || "/static/default-avatar.png"}" alt="${shop.name} shop image" />
          <div class="category-badge">${capitalize(shop.category)}</div>
          <h3>${shop.name}</h3>
<<<<<<< HEAD
          <div class="store-dist">${shop.distance ? ${shop.distance} km away : ""}</div>
=======
          <div class="store-dist">${shop.distance ? `${shop.distance} km away` : ""}</div>
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
          `;
        shopElem.addEventListener("click", () => {
          openMenuModal(shop.id, shop.name);
          if (shop.email) fetchItemsBySeller(shop.email);
          else
<<<<<<< HEAD
            document.getElementById("items-list").innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">No items info available for this shop.</div>;
=======
            document.getElementById("items-list").innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">No items info available for this shop.</div>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        });
        shopElem.addEventListener("keypress", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            openMenuModal(shop.id, shop.name);
            if (shop.email) fetchItemsBySeller(shop.email);
          }
        });
        storeList.appendChild(shopElem);
      });
      // Clear items-list if shops refreshed
      document.getElementById("items-list").innerHTML =
        '<div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>';
    }

    // Fetch items for selected seller
    function fetchItemsBySeller(sellerEmail) {
      const itemsList = document.getElementById("items-list");
<<<<<<< HEAD
      itemsList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">Loading items...</div>;
      fetch(/api/items?seller_email=${encodeURIComponent(sellerEmail)})
=======
      itemsList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Loading items...</div>`;
      fetch(`/api/items?seller_email=${encodeURIComponent(sellerEmail)}`)
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        .then((res) => {
          if (!res.ok) throw new Error("Failed to fetch items");
          return res.json();
        })
        .then((data) => {
          const items = data.items || [];
          if (items.length === 0) {
<<<<<<< HEAD
            itemsList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">No items found for this shop.</div>;
=======
            itemsList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">No items found for this shop.</div>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
            return;
          }
          displayItems(items);
        })
        .catch(() => {
<<<<<<< HEAD
          itemsList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">Error loading items.</div>;
=======
          itemsList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Error loading items.</div>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        });
    }

    // Show items in UI
    function displayItems(items) {
      const itemsList = document.getElementById("items-list");
      itemsList.innerHTML = "";
      items.forEach((item) => {
        const card = document.createElement("div");
        card.className = "store-card";
        card.innerHTML = `
          <img src="${item.image_url || "/static/default-avatar.png"}" alt="${item.name}" />
          <div class="category-badge">${capitalize(item.type)}</div>
          <h3>${item.name}</h3>
          <div class="store-dist">â‚¹${item.price.toFixed(2)}</div>
          <button aria-label="Add ${item.name} to cart" style="background:#D81BA0; color:#fff; border:none; border-radius:8px; padding:6px 12px; cursor:pointer; font-weight:bold;">
          Add to Cart
          </button>
          `;
        const btn = card.querySelector("button");
        btn.addEventListener("click", () => handleAddToCart(item));
        itemsList.appendChild(card);
      });
    }

    function capitalize(str) {
      if (!str) return "";
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Menu modal controls
    function openMenuModal(shopId, shopName) {
      const menuModal = document.getElementById("menuModal");
      const menuTitle = document.getElementById("menuModalTitle");
      const menuContent = document.getElementById("menuContent");

<<<<<<< HEAD
      menuTitle.textContent = Menu - ${shopName};
      menuContent.innerHTML = <p>Loading menu...</p>;
=======
      menuTitle.textContent = `Menu - ${shopName}`;
      menuContent.innerHTML = `<p>Loading menu...</p>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
      menuModal.setAttribute("aria-hidden", "false");
      menuModal.classList.add("active");
      menuModal.focus();

<<<<<<< HEAD
      fetch(/api/shop/${shopId}/menu)
=======
      fetch(`/api/shop/${shopId}/menu`)
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        .then((resp) => {
          if (!resp.ok) throw new Error("Failed to fetch menu");
          return resp.json();
        })
        .then((data) => {
          if (!data || !Array.isArray(data.menu) || data.menu.length === 0) {
<<<<<<< HEAD
            menuContent.innerHTML = <p>No menu items found.</p>;
=======
            menuContent.innerHTML = `<p>No menu items found.</p>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
            return;
          }
          renderMenuItems(data.menu);
        })
        .catch(() => {
<<<<<<< HEAD
          menuContent.innerHTML = <p>Failed to load menu. Please try again later.</p>;
=======
          menuContent.innerHTML = `<p>Failed to load menu. Please try again later.</p>`;
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        });
    }

    function renderMenuItems(items) {
      const menuContent = document.getElementById("menuContent");
      menuContent.innerHTML = "<ul></ul>";
      const ul = menuContent.querySelector("ul");
      items.forEach((item) => {
        const li = document.createElement("li");
        const itemInfo = document.createElement("div");
        itemInfo.className = "item-info";

        const itemName = document.createElement("div");
        itemName.className = "item-name";
        itemName.textContent = item.name;

        const itemDesc = document.createElement("div");
        itemDesc.className = "item-desc";
        if (item.description) {
          itemDesc.textContent = item.description;
        } else {
          itemDesc.textContent = "";
        }

        itemInfo.appendChild(itemName);
        if (item.description) itemInfo.appendChild(itemDesc);

        const itemPrice = document.createElement("div");
        itemPrice.className = "item-price";
<<<<<<< HEAD
        itemPrice.textContent = â‚¹${item.price.toFixed(2)};

        const addButton = document.createElement("button");
        addButton.textContent = "Add to Cart";
        addButton.setAttribute("aria-label", Add ${item.name} to cart);
=======
        itemPrice.textContent = `â‚¹${item.price.toFixed(2)}`;

        const addButton = document.createElement("button");
        addButton.textContent = "Add to Cart";
        addButton.setAttribute("aria-label", `Add ${item.name} to cart`);
>>>>>>> fe98b5efa44900d1787107ada63ce7c636e0bc91
        addButton.onclick = () => handleAddToCart(item);

        li.appendChild(itemInfo);
        li.appendChild(itemPrice);
        li.appendChild(addButton);

        ul.appendChild(li);
      });
    }

    function closeMenuModal() {
      const menuModal = document.getElementById("menuModal");
      menuModal.classList.remove("active");
      menuModal.setAttribute("aria-hidden", "true");
    }

    // Add to cart handler
    function handleAddToCart(item) {
      if (!isUserLoggedIn) {
        openLoginPrompt();
        return;
      }
      cartCount++;
      updateCartCount();
      alert(`Added "${item.name}" to cart.`);
    }

    function updateCartCount() {
      const cartCountElem = document.getElementById("cart-count");
      cartCountElem.textContent = cartCount;
    }

    // Login prompt modal controls
    function openLoginPrompt() {
      const loginPrompt = document.getElementById("loginPromptModal");
      loginPrompt.classList.add("active");
      loginPrompt.setAttribute("aria-hidden", "false");
      loginPrompt.focus();
    }

    function closeLoginPrompt() {
      const loginPrompt = document.getElementById("loginPromptModal");
      loginPrompt.classList.remove("active");
      loginPrompt.setAttribute("aria-hidden", "true");
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const menuModal = document.getElementById("menuModal");
        if (menuModal.classList.contains("active")) {
          closeMenuModal();
        }
        const loginPrompt = document.getElementById("loginPromptModal");
        if (loginPrompt.classList.contains("active")) {
          closeLoginPrompt();
        }
        const locationModal = document.getElementById("locationModal");
        if (locationModal.classList.contains("active")) {
          locationModal.classList.remove("active");
        }
      }
    });

    // Category change triggers shop filter
    function categoryChanged() {
      const categorySelect = document.getElementById("categorySelect");
      CURRENT_CATEGORY = categorySelect.value;
      applyFilters();
    }

    // Search triggers shop filter
    function triggerSmartSearch() {
      const searchInput = document.getElementById("searchInput");
      SEARCH_TEXT = searchInput.value.trim().toLowerCase();
      applyFilters();
    }

    // Filter shops by category and search text
    function applyFilters() {
      if (!CURRENT_SHOPS || !Array.isArray(CURRENT_SHOPS)) return;
      let filtered = CURRENT_SHOPS;

      // Filter by category
      if (CURRENT_CATEGORY && CURRENT_CATEGORY !== "") {
        filtered = filtered.filter((shop) => shop.category === CURRENT_CATEGORY);
      }

      // Filter by search text (shop name or address or contact or matching product)
      if (SEARCH_TEXT && SEARCH_TEXT.length > 0) {
        filtered = filtered.filter((shop) => {
          const baseText = (
            (shop.name || "") +
            " " +
            (shop.address || "") +
            " " +
            (shop.contact || "")
          ).toLowerCase();

          // Also check matching_products if available
          const productsText = shop.matching_products
            ? shop.matching_products.join(" ").toLowerCase()
            : "";

          return (
            baseText.includes(SEARCH_TEXT) || productsText.includes(SEARCH_TEXT)
          );
        });
      }

      showShops(filtered);

      // Clear items list because shop list changed
      document.getElementById("items-list").innerHTML =
        '<div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>';
    }

    // On page load show location modal initially
    window.onload = () => {
      document.getElementById("locationModal").classList.add("active");
    };
  </script>
</body>
</html>
