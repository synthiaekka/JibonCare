
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HaatXpress - Local Shops Delivered</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #fff;
      margin: 0; padding: 0;
      color: #443315;
      min-height: 100vh;
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a, button {
      user-select: none;
    }
    header {
      background-color: #5C3A21;
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HaatXpress</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='/style1.css') }}">

  <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />-->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      <!--background: linear-gradient(to right, #44315d, #522c54, #372a45);-->
      background: #fafafa      min-height: 100vh;
      margin: 0; padding: 0;
    }
    header {
      background-color: #400d2e;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      flex-wrap: wrap;
      box-shadow: 0 3px 9px rgba(92, 58, 33, 0.7);
      position: relative;
      z-index: 1000;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo img {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      user-select: none;
    }
    .location {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      color: #FFD366;
    }
    .location i {
      color: #D81BA0;
    }
    .location button#change-location-btn {
      margin-left: 8px;
      background-color: #D81BA0;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .location button#change-location-btn:hover {
      background-color: #7f58e7;
    }
    .nav-main {
      display: flex;
      align-items: center;
      gap: 30px;
      flex: 1;
      justify-content: center;
      user-select: none;
      box-shadow: 0 3px 9px #21173344;
      position:relative; z-index:20;
    }
    .category-dropdown {
      border-radius: 10px;
      padding: 7px 16px;
      font-size: 16px;
      background: #f7f0ff;
      color: #5C3A21;
      border: 1.5px solid #D81BA0;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    .category-dropdown:hover,
    .category-dropdown:focus {
      border-color: #7f58e7;
      outline: none;
      box-shadow: 0 0 10px #7f58e7aa;
    }
    .search-bar {
      display: flex;
      align-items: center;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 18px #d81ba020;
    }
    .search-bar input {
      padding: 8px 14px;
      border: none;
      font-size: 14px;
      outline: none;
      min-width: 220px;
      color: #5C3A21;
    }
    .search-bar button {
      padding: 8px 12px;
      background-color: #D81BA0;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
    }
    .search-bar button:hover {
      background-color: #7f58e7;
    }
    .auth-cart {
      display: flex;
      align-items: center;
      gap: 18px;
      position: relative;
      user-select: none;
    }
    .auth-cart a, .auth-cart span {
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.05em;
      cursor: pointer;
      padding: 6px 15px;
      border-radius: 6px;
      background: #D81BA0;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .auth-cart a:hover {
      background-color: #7f58e7;
    }
    .auth-cart .fa-shopping-cart {
      color: white !important;
      font-size: 22px;
      position: relative;
    }
    #cart-count {
      position: absolute;
      top: -8px;
      right: -10px;
      background: #7f58e7;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 50%;
      font-weight: bold;
      user-select: none;
    }
    .hero {
      text-align: center;
      color: #5C3A21;
      padding: 60px 20px 38px;
      max-width: 600px;
      margin: 20px auto 40px;
      border-radius: 15px;
      background: #fff0fa;
      box-shadow: 0 0 25px rgba(128, 60, 131, 0.3);
      user-select: none;
    }
    .hero h2 {
      font-size: 2.6rem;
      letter-spacing: 0.2ch;
      margin-bottom: 15px;
      font-weight: 700;
      color: #7f58e7;
    }
    .hero p {
      font-size: 1.15rem;
      color: #6a4f73;
      letter-spacing: 0.02ch;
      line-height: 1.5;
    }
      border-radius:10px; padding:7px 16px; font-size:16px; background:#ede2fc; color:#522c54; border:none;
      margin-right:18px; outline:none;
      box-shadow:0 4px 18px #7b1fa22c, 0 1.5px 0 #fff4;
      font-weight:500;
    }
    .category-dropdown:focus { box-shadow:0 0 0 3px #a087e6;}
    .search-bar { display: flex; align-items: center;}
    .search-bar input { padding: 8px 12px; border-radius: 10px 0 0 10px; border: none; font-size: 14px;}
    .search-bar button { padding: 8px 12px; background-color: #ae3e63; color: white; border: none; border-radius: 0 10px 10px 0; cursor: pointer;}
    .auth-cart { display: flex; align-items: center; gap: 20px; }
    .auth-cart a, .auth-cart span { color: white; text-decoration: none; font-weight: 500; }
    .hero {
      text-align: center; color: #0b0b0b;
      padding: 60px 20px 38px 20px;
      text-shadow: 0 6px 14px #18182892;
    }

    .nav-links {
  display: flex;
  align-items: center;
  gap: 20px;
}

.nav-links a {
  color: #fafafa;
  text-decoration: none;
  font-weight: 500;
}

.dropdown {
  position: relative;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #ae3e63;
  min-width: 160px;
  top: 100%;
  left: 0;
  box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
  z-index: 1;
}

.dropdown-content a {
  display: block;
  padding: 10px;
  color: white;
  text-decoration: none;
}

.dropdown:hover .dropdown-content {
  display: block;
}

    .hero h2 { font-size: 2.4rem; letter-spacing:0.2ch; }
    .hero p { font-size: 1.13rem; max-width: 600px; margin: auto; color: #0b0b0b; letter-spacing:0.02ch; }
    .store-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 40px 4vw;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto 60px;
      user-select: none;
    }
    .store-card {
      background: #fff0fa;
      color: #5C3A21;
      padding: 22px 14px 20px;
      border-radius: 16px;
      min-width: 240px;
      max-width: 265px;
      box-shadow: 0 6px 12px #b97fc0aa;
      cursor: pointer;
      transition: box-shadow 0.25s, transform 0.21s;
      border: 1px solid #D81BA0;
      text-align: center;
      position: relative;
      user-select: none;
    }
    .store-card:hover {
      background: #e9d6f9;
      box-shadow: 0 14px 36px #7f58e7aa;
      transform: translateY(-6px) scale(1.06);
      border-color: #7f58e7;
    }
    .store-card img {
      width: 72px;
      height: 72px;
      margin: 8px auto 16px auto;
      display: block;
      border-radius: 15px;
      object-fit: cover;
      box-shadow: 0 6px 14px #ae73cdcc;
      user-select: none;
    }
    .store-card h3 {
      margin: 6px 0 8px;
      font-size: 1.2em;
      font-weight: 700;
      color: #5C3A21;
      user-select: text;
      background: linear-gradient(145deg, #51416c 82%, #422d4c 100%);
      color: white; padding: 22px 12px 19px 12px; border-radius: 17px; min-width:230px; width: 265px;
      box-shadow: 0 4px 35px #22133060, 0 2px 0 #fff1;
      cursor: pointer;
      transition: box-shadow 0.25s, transform 0.19s;
      border: 1.3px solid #765098;
      text-align: center;
      position:relative;
    }
    .store-card:hover {
      background: linear-gradient(135deg, #706eb2 68%, #7a4bc4 100%);
      box-shadow: 0 13px 35px #221330a0, 0 4px 0 #fff4;
      transform: translateY(-7px) scale(1.055) rotate(-1deg);
      border-color:#ae3e63;
    }
    .store-card img {
      width:70px; height:70px;
      margin: 8px auto 17px auto; display:block; border-radius:15px; object-fit: cover; box-shadow: 0 3px 16px #0004;
    }
    .category-badge {
      display:inline-block; border-radius:9px; font-size:13px; color:#223146; background:#fafafa;
      padding:2.5px 12px; margin-bottom:7px; font-weight:500; box-shadow:0 1.5px 0 #c6fff9;
    }
    .modal {
      display: none;
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      max-width: 420px;
      min-width: 280px;
      background: #422d4bdd;
      color: #f3eefd;
      border-radius: 16px;
      padding: 36px 34px 28px 34px;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 5px 43px #765097cc;
      user-select: none;
    }
    .modal.active {
      display: block;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-close {
      background: #7f58e7;
      border: none;
      padding: 10px 19px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      transition: background-color 0.25s ease;
    }
    .modal-close:hover {
      background: #D81BA0;
    }
    .modal h2 {
      margin: 0;
      color: #c4a7f9;
      font-weight: 700;
      user-select: none;
    }
    .modal ul {
      margin: 15px 0 0 0;
      padding: 0;
      list-style: none;
      max-height: 50vh;
      overflow-y: auto;
    }
    .modal li {
      margin: 10px 0;
      padding: 7px 14px;
      border-radius: 10px;
      background: #60486c;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2.5px 12px #8f7fc299;
      font-size: 1em;
      user-select: none;
    }
    .modal li .item-info {
      display: flex;
      flex-direction: column;
      max-width: 75%;
    }
    .modal li .item-name {
      font-weight: 700;
      margin-bottom: 3px;
      color: #e5d1f5;
    }
    .modal li .item-desc {
      font-size: 0.85em;
      color: #c9b5de;
    }
    .modal li .item-price {
      font-weight: 700;
      color: #d1adf4;
      margin-right: 10px;
      white-space: nowrap;
      user-select: text;
    }
    .modal li button {
      padding: 6px 14px;
      background: #D81BA0;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
      user-select: none;
      white-space: nowrap;
    }
    .modal li button:hover {
      background: #7f58e7;
    }
    #total-price {
      margin-top: 18px;
      font-size: 1.05em;
      font-weight: 700;
      user-select: none;
      color: #c299f5;
    }
    .login-modal {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(92, 58, 33, 0.9);
      z-index: 4000;
      text-align: center;
      color: white;
      min-height: 0;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      animation: fadein 0.3s ease-in;
      user-select: none;
    }
    .login-modal.active {
      display: flex;
    }
    @keyframes fadein {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    .login-modal h2 {
      font-size: 1.8em;
      margin-bottom: 14px;
      color: #E1BEE7;
      user-select: none;
    }
    .login-modal p {
      font-size: 1.2em;
      margin-bottom: 30px;
      color: #D8B6E1;
      user-select: none;
    }
    .login-modal a {
      background: #D81BA0;
      display: inline-block;
      margin: 0 16px;
      padding: 16px 40px;
      border-radius: 10px;
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.2em;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .login-modal a:hover {
      background: #7f58e7;
    }
    .login-modal button {
      margin-top: 30px;
      padding: 10px 36px;
      border-radius: 8px;
      background: #e74c3c;
      color: white;
      border: none;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .login-modal button:hover {
      background: #bf1e24;
    }
    #locationModal.login-modal.active {
      display: flex !important;
      flex-direction: column;
      background: rgba(92, 58, 33, 0.9);
      z-index: 5000;
      padding: 30px 20px;
    }
    #locationModal h2, #locationModal p {
      color: #f5d0fa;
      user-select: none;
    }
    #locationModal input {
      padding: 12px 16px;
      border-radius: 10px;
      width: 80%;
      max-width: 320px;
      font-size: 1em;
      border: 2px solid #D81BA0;
      margin-bottom: 15px;
      outline: none;
      color: #5C3A21;
      font-weight: 700;
      user-select: text;
      transition: border-color 0.3s ease;
    }
    #locationModal input:focus {
      border-color: #7f58e7;
      box-shadow: 0 0 7px #7f58e7cc;
    }
    #locationModal button {
      padding: 12px 32px;
      border-radius: 10px;
      background: #D81BA0;
      color: white;
      font-weight: 700;
      font-size: 1.15em;
      cursor: pointer;
      border: none;
      user-select: none;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 12px #d81baacc;
    }
    #locationModal button:hover {
      background: #7f58e7;
      box-shadow: 0 5px 15px #7f58e7cc;
    }
    @media (max-width: 700px) {
      .store-section {
        flex-direction: column;
        padding: 30px 4vw;
      }
      .store-card {
        width: auto;
        max-width: 100%;
      }
      .modal {
        left: 2vw;
        width: 96vw;
      }
    .modal.active { display: block; }
    .modal-close { float: right; background: #ae3e63; border: none; padding:10px 19px; border-radius: 5px; color: white; cursor: pointer;}
    .modal ul { margin:35px 0 0 0; padding:0; list-style:none;}
    .modal li { margin:13px 0; padding:7px 0 7px 12px; border-radius:8px; background:#534160; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2.5px 10px #6288661a;}
    .modal li button { padding:4px 13px; background: #AD5E78FF; color:#372a45; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
    .modal li button:hover { background:#fafafa; color:#0b0b0b;}
    .modal h2 { margin-bottom: 7px;}
    #total-price {margin-top:15px; font-size:1.01em;}
    footer { background-color: #0b0b0b; color: #fafafa; text-align: center; padding: 20px;}
    .login-modal { display: none; position: fixed; left: 0; right: 0; top: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(40,21,64,0.80); z-index: 3000; text-align: center; color: #fff; min-height: 0; justify-content: center; align-items: center;}
    .login-modal.active { display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadein .27s; }
    @keyframes fadein { from { opacity: 0; } to   { opacity: 1; } }
    .login-modal h2 { font-size: 1.7em; margin-bottom: 10px; }
    .login-modal p { font-size:1.1em; color:#ccc; margin-bottom: 25px;}
    .login-modal a { background: #6a8973; display: inline-block; margin: 10px 16px; padding: 12px 32px; border-radius: 8px; color:#fff; text-decoration: none; font-weight:600; font-size:1.1em; transition: background .18s;}
    .login-modal a:hover { background:#44315d;}
    .login-modal button { margin-top: 30px; padding: 8px 25px; border-radius:7px; background:#e74c3c; color: #fff; border: none; font-size:1em; font-weight:bold;}
    .modal { z-index:1500; }
    @media (max-width:700px){
      .store-section { flex-direction:column; }
      .store-card { width:98vw; min-width:97vw;}
      .modal { left:2vw; width:96vw; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="{{ url_for('static', filename='images/jiboncare_Logo.png') }}" alt="HaatXpress Logo" />
    <div class="location" aria-live="polite" aria-atomic="true">
      <i class="fas fa-map-marker-alt"></i>
      <span id="location-text">Please set your location</span>
  <!-- HEADER 
  <header>
    <div class="logo">
      <img src="{{ url_for('static', filename='images/jiboncare_Logo.png') }}" alt="HaatXpress Logo">
      <div class="location">
        <i class="fas fa-map-marker-alt"></i>
        <span id="location-text">Detecting your location...</span>
        <button onclick="detectLocation()" style="margin-left:7px;background:#7f58e7;color:#fff;border:none;border-radius:5px;padding:3px 10px;cursor:pointer;">
          <i class="fa fa-crosshairs"></i> Update
        </button>
      </div>
    </div>
  </div>
  <div class="nav-main">
    <label for="categorySelect" style="color:#fff;font-weight:600;margin-right:7px;">Select Category:</label>
    <select id="categorySelect" class="category-dropdown" onchange="categoryChanged()" aria-label="Select category">
      <option value="">All</option>
      <option value="grocery">Grocery</option>
      <option value="medicine">Medicine</option>
      <option value="food-item">Restaurant</option>
    </select>
    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search store, product or location..." onkeyup="triggerSmartSearch()" aria-label="Search stores, products or location" />
      <button aria-label="Search"><i class="fas fa-search"></i></button>
    </div>
  </div>
  <div class="auth-cart">
    {% if user_email %}
      <span id="user-email" style="color:#FFD366;" aria-label="User email">{{ user_email }}</span>
      <a href="/logout" role="button" aria-label="Logout">Logout</a>
    {% else %}
      <a href="/register" role="button" aria-label="Register">Register</a>
      <a href="/login" role="button" aria-label="Login">Login</a>
    {% endif %}
    <a href="#" role="button" aria-label="Shopping cart">
      <i class="fas fa-shopping-cart" style="position: relative;">
        <span id="cart-count">0</span>
      </i>
    </a>
  </div>
</header>

<section class="hero" role="banner">
  <h2>Welcome to HaatXpress</h2>
  <p>Connecting you directly to local shops - groceries, medicines, food, all from your trusted neighborhood within your zone. Stay happyüòÄ‚ù§</p>
</section>

<section class="store-section" id="store-list" aria-label="List of shops">
  <div style="color:#5C3A21;text-align:center;width:100%;">Please set your location to see shops.</div>
</section>

<section class="store-section" id="items-list" aria-label="Items uploaded by selected shop">
  <div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>
</section>

<!-- Location Input Modal -->
<div class="modal login-modal active" id="locationModal" role="dialog" aria-modal="true" aria-labelledby="locationModalTitle" tabindex="-1">
  <h2 id="locationModalTitle">Where do you want to order from?</h2>
  <p>Please enter your area, city, or PIN code to see sellers near you.</p>
  <input type="text" id="user-location-input" placeholder="Enter your location" aria-label="Enter your location" />
  <br/>
  <button onclick="submitUserLocation()">Confirm Location</button>
</div>

<!-- Login/Register Prompt Modal -->
<div class="login-modal" id="loginPromptModal" role="dialog" aria-modal="true" aria-labelledby="loginPromptTitle" tabindex="-1" aria-hidden="true">
  <h2 id="loginPromptTitle">Please Log In / Register</h2>
  <p>You need to be logged in to add items to your cart.</p>
  <a href="/login" role="button" aria-label="Go to Login">Login</a>
  <a href="/register" role="button" aria-label="Go to Register">Register</a>
  <button onclick="closeLoginPrompt()" aria-label="Close">Cancel</button>
</div>

<!-- Shop Menu Modal -->
<div class="modal" id="menuModal" role="dialog" aria-modal="true" aria-labelledby="menuModalTitle" tabindex="-1" aria-hidden="true">
  <div class="modal-header">
    <h2 id="menuModalTitle">Shop Menu</h2>
    <button class="modal-close" aria-label="Close Menu" onclick="closeMenuModal()">&times;</button>
  </div>
  <div id="menuContent">
    <p>Loading menu...</p>
  </div>
</div>

<footer role="contentinfo"><center>
  <p>&copy; 2025 HaatXpress. Made with üß° for your neighborhood.</p>
  <p>Contact: <a href="mailto:support@haatexpress.com">support@haatexpress.com</a></p>
  </center>
</footer>

<script>
  let userLocation = null;
  const isUserLoggedIn = Boolean(document.getElementById('user-email'));
  let cartCount = 0;

  function submitUserLocation() {
    const input = document.getElementById('user-location-input');
    const location = input.value.trim();
    if (!location) {
      alert('Please enter a valid location.');
      return;
    }
    userLocation = location;
    document.getElementById('locationModal').classList.remove('active');
    updateHeaderLocation();
    fetchShopsByArea(userLocation);
  }

  function updateHeaderLocation() {
    const locationText = document.getElementById('location-text');
    locationText.textContent = userLocation + ' ';
    if (!document.getElementById('change-location-btn')) {
      const locationDiv = locationText.parentElement;
      const btn = document.createElement('button');
      btn.id = 'change-location-btn';
      btn.textContent = 'Change';
      btn.style.cssText = 'margin-left:8px; background:#D81BA0; color:#fff; border:none; border-radius:5px; padding:3px 10px; cursor:pointer; font-weight:600;';
      btn.setAttribute('aria-label', 'Change your location');
      btn.onmouseenter = () => btn.style.backgroundColor = '#7f58e7';
      btn.onmouseleave = () => btn.style.backgroundColor = '#D81BA0';
      btn.onclick = openLocationModal;
      locationDiv.appendChild(btn);
    }
  }

  function openLocationModal() {
    document.getElementById('locationModal').classList.add('active');
    document.getElementById('user-location-input').value = '';
  }

  function fetchShopsByArea(area) {
    const storeList = document.getElementById('store-list');
    storeList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">Loading shops...</div>;
    fetch(/api/shops?area=${encodeURIComponent(area)})
      .then(response => {
        if (!response.ok) throw new Error('API error');
        return response.json();
      })
      .then(data => {
        const shops = data.shops || data;
        showShops(shops);
      })
      .catch(() => {
        storeList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;"></div>;
      });
  }

  function showShops(shops) {
    const storeList = document.getElementById('store-list');
    if (!shops || shops.length === 0) {
      storeList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">No shops found in your area.</div>;
      return;
    }
    storeList.innerHTML = '';
    shops.forEach(shop => {
      const shopElem = document.createElement('div');
      shopElem.className = 'store-card';
      shopElem.tabIndex = 0;
      shopElem.setAttribute('role', 'region');
      shopElem.setAttribute('aria-label', ${shop.name} shop);
      shopElem.innerHTML = `
        <img src="${shop.image_url || '/static/default-avatar.png'}" alt="${shop.name} shop image" />
        <div class="category-badge">${shop.category}</div>
        <h3>${shop.name}</h3>
        <div class="store-dist">${shop.distance ? ${shop.distance} km away : ''}</div>
      `;
      shopElem.addEventListener('click', () => {
        openMenuModal(shop.id, shop.name);
        // Fetch and display seller's items
        if(shop.email) fetchItemsBySeller(shop.email);
        else document.getElementById('items-list').innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">No items info available for this shop.</div>;
      });
      shopElem.addEventListener('keypress', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openMenuModal(shop.id, shop.name);
          if(shop.email) fetchItemsBySeller(shop.email);
        }
      });
      storeList.appendChild(shopElem);
    });
  }

  function fetchItemsBySeller(sellerEmail) {
    const itemsList = document.getElementById('items-list');
    itemsList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">Loading items...</div>;
    fetch(/api/items?seller_email=${encodeURIComponent(sellerEmail)})
      .then(res => {
        if (!res.ok) throw new Error("Failed to fetch items");
        return res.json();
      })
      .then(data => {
        const items = data.items || [];
        if (items.length === 0) {
          itemsList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;">No items found for this shop.</div>;
          return;
        }
        displayItems(items);
      })
      .catch(() => {
        itemsList.innerHTML = <div style="color:#5C3A21;text-align:center;width:100%;"> </div>;
      });
  }

  function displayItems(items) {
    const itemsList = document.getElementById('items-list');
    itemsList.innerHTML = '';
    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'store-card';
      card.innerHTML = `
       
    fetch(/api/shop/${shopId}/menu)
      .then(resp => {
        if (!resp.ok) throw new Error('');
        return resp.json();
      })
      .then(data => {
        if (!data || !Array.isArray(data.menu) || data.menu.length === 0) {
          menuContent.innerHTML = <p>No menu items found.</p>;
          return;
        }
        renderMenuItems(data.menu);
      })
      .catch(() => {
        menuContent.innerHTML = <p></p>;
      });
  }

  function renderMenuItems(items) {
    const menuContent = document.getElementById('menuContent');
    menuContent.innerHTML = '<ul></ul>';
    const ul = menuContent.querySelector('ul');

    items.forEach(item => {
      const li = document.createElement('li');

      const itemInfo = document.createElement('div');
      itemInfo.className = 'item-info';

      const itemName = document.createElement('div');
      itemName.className = 'item-name';
      itemName.textContent = item.name;

      if (item.description) {
        const itemDesc = document.createElement('div');
        itemDesc.className = 'item-desc';
        itemDesc.textContent = item.description;
        itemInfo.appendChild(itemDesc);
    <div class="auth-cart">
      {% if user_email %}
        <span style="color:#6a8973;">{{ user_email }}</span>
        <a href="/logout">Logout</a>
      {% else %}
        <a href="/register">Register</a>
        <a href="/login">Login</a>
      {% endif %}
      <a href="#">
        <i class="fas fa-shopping-cart" style="position: relative;">
          <span id="cart-count" style="position: absolute;top: -8px;right: -10px;background: #6a8973;color: white;font-size: 10px;padding: 2px 5px;border-radius: 50%;">0</span>
        </i>
      </a>
    </div>
  </header>-->

  <!-- HEADER -->
<header>
  <div class="logo">
    <img src="{{ url_for('static', filename='images/jiboncare_Logo.png') }}" alt="HaatXpress Logo" style="width: 60px; height: 60px;">
    <div class="location">
    <i class="fas fa-map-marker-alt"></i>
    <span id="location-text">Detecting your location...</span>
  </div>

  </div>

  <!--<div class="nav-main">
    <div class="nav-links">
      <a href="#">Home</a>
      <a href="#">About</a>
      <div class="dropdown">
        <a href="#">Choose Store</a>
        <div class="dropdown-content">
          <a href="#">Grocery</a>
          <a href="#">Medicine</a>
          <a href="#">Restaurant</a>
        </div>
      </div>
    </div>-->

    <!-- NAVIGATION LINKS -->
<div class="nav-main">
  <div class="nav-links">
    <a href="/" style="color: #fafafa; text-decoration: none; font-weight: 500;">Home</a>
    <a href="/about" style="color: white; text-decoration: none; font-weight: 500;">About</a>

    <div class="dropdown">
      <a href="#" style="color: #fafafa; text-decoration: none; font-weight: 500;">Choose Store</a>
      
        <!--<a href="#" onclick="filterCategory('medicine')">Medicine</a>
        <a href="#" onclick="filterCategory('food-item')">Restaurant</a>-->
      </div>
    </div>
  </div>



    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search store, product or location..." onkeyup="triggerSmartSearch()" />
      <button><i class="fas fa-search"></i></button>
    </div>
  </div>

  <!--<div class="auth-cart">
    {% if user_email %}
      <span style="color:#6a8973;">{{ user_email }}</span>
      <a href="/logout">Logout</a>
    {% else %}
      <!--<a href="/register">Register</a>-
      <a href="/login">Login</a>
    {% endif %}
    <a href="#">
      <i class="fas fa-shopping-cart" style="position: relative;">
        <span id="cart-count" style="
          position: absolute;
          top: -8px;
          right: -10px;
          background: #6a8973;
          color: white;
          font-size: 10px;
          padding: 2px 5px;
          border-radius: 50%;
        ">0</span>
      </i>
    </a>
  </div>-->
  <div class="auth-cart">
  {% if user_email %}
    <div class="dropdown">
      <a href="#" class="btn">{{ user_name or user_email.split('@')[0] }}</a>
      <div class="dropdown-content">
        <a href="#">Profile</a>
        <a href="/logout">Logout</a>
      </div>
    </div>
  {% else %}
    <a href="/login">Login</a>
  {% endif %}
  <a href="#">
    <i class="fas fa-shopping-cart" style="position: relative;">
      <span id="cart-count" style="
        position: absolute;
        top: -8px;
        right: -10px;
        background: #6a8973;
        color: white;
        font-size: 10px;
        padding: 2px 5px;
        border-radius: 50%;
      ">0</span>
    </i>
  </a>
</div>


  
</header>


  <!-- HERO -->
  <div class="hero">
    <h2>Welcome to HaatXpress</h2>
    <p>Connecting you directly to local shops - groceries, medicines, food, all from your trusted neighborhood within your zone.Stay happyüòÄ‚ù§</p>
  </div>

  <!-- SHOPS LIST -->
  <div class="store-section" id="store-list">
    <div style="color:white;text-align:center;width:100%;">Loading all shops...</div>
  </div>

  <!-- MODAL: Products of this shop -->
  <div class="modal" id="modal" onclick="clickOutsideModal(event)">
    <button class="modal-close" onclick="closeModal()">Close</button>
    <h2 id="modal-title">Store Name</h2>
    <ul id="product-list"></ul>
    <p id="total-price" style="margin-top:20px;font-weight:bold;">Total: ‚Çπ0</p>
  </div>

  <!-- LOGIN/SIGNUP PROMPT MODAL -->
  <div class="login-modal" id="loginModal">
    <h2>Please Login or Register</h2>
    <p>You must be logged in to add items to your cart.</p>
    <a href="/login">Login</a>
    <a href="/register">Register</a>
    <br>
    <button onclick="closeLoginModal()">Cancel</button>
  </div>

  <!-- FOOTER -->
  <footer>
    <p>&copy; 2025 HaatXpress. Made with üß° for your neighborhood.</p>
    <p>Contact: <a href="mailto:support@haatexpress.com" style="color:#6a8973;">support@haatexpress.com</a></p>
  </footer>

<script>
let cart = [];
let total = 0;
const USER_LOGGED_IN = "{{ user_email|default('') }}";
let USER_LAT = null, USER_LNG = null;
let GLOBAL_SHOPS = [];
let CATEGORY = "";

// --- LOCATION ---

function detectLocation() {
  document.getElementById('location-text').innerText = 'Detecting your location...';
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        USER_LAT = pos.coords.latitude;
        USER_LNG = pos.coords.longitude;
        document.getElementById('location-text').innerText = Lat: ${USER_LAT.toFixed(4)}, Lng: ${USER_LNG.toFixed(4)};
        loadShops();
      },
      function(err) {
        document.getElementById('location-text').innerText = "Location unavailable";
        USER_LAT = USER_LNG = null;
        loadShops();
      }
    );
  } else {
    document.getElementById('location-text').innerText = "Geolocation not supported";
    USER_LAT = USER_LNG = null;
  }
}

// --- SMART SHOP LOAD + SEARCH ---

function categoryChanged() {
  CATEGORY = document.getElementById('categorySelect').value;
  document.getElementById('searchInput').value = "";
  loadShops();
  closeModal();
}

function loadShops() {
  let url = '/customer/shops';
  let params = [];
  if(CATEGORY) params.push('category=' + encodeURIComponent(CATEGORY));
  if (USER_LAT !== null && USER_LNG !== null) {
    params.push("lat=" + encodeURIComponent(USER_LAT));
    params.push("lng=" + encodeURIComponent(USER_LNG));
  }
  if (params.length) url += '?' + params.join('&');

  fetch(url)
    .then(res => res.json())
    .then(shops => {
      GLOBAL_SHOPS = shops;
      displayShops(shops);
    });
}

function displayShops(shoplist) {
  let html = '';
  const text = document.getElementById('searchInput').value.trim().toLowerCase();
  for (const s of shoplist) {
    if(text && !(
      ((s.shop_name||'') + ' ' + (s.shop_address||'') + ' ' + (s.shop_contact||'')).toLowerCase().includes(text)
      || (s.matching_products && s.matching_products.join(' | ').toLowerCase().includes(text))
    )) continue; // frontend filter for shop name/address/search combo

    html += 
      <div class="store-card"
        data-name="${(s.shop_name||'') + ' ' + (s.shop_address||'') + ' ' + (s.shop_contact||'')}"
        onclick="showShopProducts('${s.email.replace(/'/g,"&#39;")}', '${(s.shop_name||'Store').replace(/'/g,"&#39;")}')">
        <span class="category-badge">
         ${s.shop_type === 'grocery' ? 'Grocery' : s.shop_type === 'medicine' ? 'Medicine' : s.shop_type === 'food-item' ? 'Restaurant' : 'Other'}
        </span>
        <img src="${s.shop_photo || '/static/default-avatar.png'}" />
        <h3>${s.shop_name || 'Unnamed Shop'}</h3>
        <div style='font-size:13px; color:#c1f6b3; margin-bottom:8px;'>${s.shop_contact || ''}</div>
        <div style='font-size:13px; color:#dedede;'>${s.shop_address || ''}</div>
        ${s.distance_km !== undefined ? <div class="store-dist">Distance: ${s.distance_km} km</div> : ""}
        ${s.matching_products && s.matching_products.length
           ? <div style="margin-top:7px;color:#a6fff8;font-size:13px;"><b>Matched products:</b> ${s.matching_products.join(', ')}</div>
           : ""}
      </div>
    ;
  }
  document.getElementById('store-list').innerHTML = html || '<div style="color:white;">No shops found for search or filters.</div>';
}

function triggerSmartSearch() {
  const text = document.getElementById('searchInput').value.trim().toLowerCase();
  // If no text: just reload from backend
  if (!text) { loadShops(); return; }

  let cat = CATEGORY || document.getElementById('categorySelect').value;
  let url = /customer/search-shops-by-product?query=${encodeURIComponent(text)};
  if(cat) url += &category=${encodeURIComponent(cat)};
  if (USER_LAT !== null && USER_LNG !== null)
    url += &lat=${USER_LAT}&lng=${USER_LNG};

  fetch(url)
    .then(res => res.json())
    .then(productShops => {
      // Also include direct text search on those currently shown
      let matchedShops = (GLOBAL_SHOPS||[]).filter(s =>
        ((s.shop_name||'') + ' ' + (s.shop_address||'') + ' ' + (s.shop_contact||'')).toLowerCase().includes(text)
      );
      let combined = [];
      let ids = new Set();
      for (let shop of productShops) {
        combined.push(shop); ids.add(shop.email);
      }
      for (let shop of matchedShops) {
        if (!ids.has(shop.email)) { combined.push(shop); ids.add(shop.email);}
      }
      displayShops(combined);
    });
}


function filterCategory(category) {
  document.getElementById('categorySelect').value = category;
  categoryChanged();
}

// --- Product modal, cart logic and login modal (unchanged) ---

function showShopProducts(shop_email, shop_name) {
  document.getElementById('modal').classList.add('active');
  document.getElementById('modal-title').innerText = shop_name;
  document.getElementById('total-price').innerText = Total: ‚Çπ${total};
  fetch(/customer/products/${encodeURIComponent(shop_email)})
    .then(res=>res.json())
    .then(products => {
      let ul = document.getElementById('product-list');
      ul.innerHTML = "";
      if (!products.length) {
        ul.innerHTML = "<li>No products yet.</li>";
        return;
      }
      for (const p of products) {
        let li = document.createElement('li');
        li.innerHTML = <span>${p.name} <b>- ‚Çπ${p.price}</b> <span style="color:#eee;font-size:12px;">(${p.type})</span></span>
          <button onclick="event.stopPropagation();addToCart('${p.name.replace(/'/g,"&#39;")}', ${+p.price});">Add to Cart</button>;
        ul.appendChild(li);
      }

      itemInfo.prepend(itemName);

      const itemPrice = document.createElement('div');
      itemPrice.className = 'item-price';
      itemPrice.textContent = ‚Çπ${item.price.toFixed(2)};

      const addButton = document.createElement('button');
      addButton.textContent = 'Add to Cart';
      addButton.setAttribute('aria-label', Add ${item.name} to cart);
      addButton.onclick = () => handleAddToCart(item);

      li.appendChild(itemInfo);
      li.appendChild(itemPrice);
      li.appendChild(addButton);

      ul.appendChild(li);
    });
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
}
function clickOutsideModal(event) {
  if (event.target.id === "modal") closeModal();
}

function addToCart(name, price) {
  if (!USER_LOGGED_IN) {
    showLoginModal();
    return;
  }
  cart.push({ name, price });
  total += price;
  document.getElementById('cart-count').innerText = cart.length;
  document.getElementById('total-price').innerText = Total: ‚Çπ${total};
}
function showLoginModal() {
  document.getElementById('loginModal').classList.add('active');
}
function closeLoginModal() {
  document.getElementById('loginModal').classList.remove('active');
}

// --- Initial load: get location, then show shops
window.onload = function() {
  CATEGORY = "";
  detectLocation();
  document.getElementById('categorySelect').value = "";
};


document.addEventListener("DOMContentLoaded", () => {
  const locationSpan = document.getElementById("location-text");

  // Check for geolocation support
  if (!navigator.geolocation) {
    locationSpan.innerText = "Geolocation not supported";
    return;
  }

  function closeMenuModal() {
    const menuModal = document.getElementById('menuModal');
    menuModal.classList.remove('active');
    menuModal.setAttribute('aria-hidden', 'true');
  }

  function handleAddToCart(item) {
    if (!isUserLoggedIn) {
      openLoginPrompt();
      return;
    }
    cartCount++;
    updateCartCount();
    alert(Added "${item.name}" to cart.);
  }
      try {
        const response = await fetch(https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json);
        if (!response.ok) throw new Error("Failed to fetch location");

  function updateCartCount() {
    const cartCountElem = document.getElementById('cart-count');
    cartCountElem.textContent = cartCount;
  }

  function openLoginPrompt() {
    const loginPrompt = document.getElementById('loginPromptModal');
    loginPrompt.classList.add('active');
    loginPrompt.setAttribute('aria-hidden', 'false');
    loginPrompt.focus();
  }

  function closeLoginPrompt() {
    const loginPrompt = document.getElementById('loginPromptModal');
    loginPrompt.classList.remove('active');
    loginPrompt.setAttribute('aria-hidden', 'true');
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      const menuModal = document.getElementById('menuModal');
      if (menuModal.classList.contains('active')) {
        closeMenuModal();
        const country = data.address.country || "";
        locationSpan.innerText = ${place ? place + ", " : ""}${country};
      } catch (error) {
        console.error("Reverse geocoding failed:", error);
        locationSpan.innerText = "Location unavailable";
      }
      const loginPrompt = document.getElementById('loginPromptModal');
      if (loginPrompt.classList.contains('active')) {
        closeLoginPrompt();
      }
      const locationModal = document.getElementById('locationModal');
      if (locationModal.classList.contains('active')) {
        locationModal.classList.remove('active');
      }
    }
  });

  function categoryChanged() {
// TODO: Implement filtering shops by category or fetching filtered shops
    console.log('Category changed - implement filtering');
  }
  function triggerSmartSearch() {
    // TODO: Implement search/filter shops or items by user input
    console.log('Search triggered - implement filtering');
  }
    
  window.onload = () => {
    document.getElementById('locationModal').classList.add('active');
  };
  );
});
</script>

</body>
</html>