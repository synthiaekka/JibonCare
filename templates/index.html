<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HaatXpress - Local Shops Delivered</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #fff;
      color: #443315;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    header {
      background-color: #5c3a21;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      box-shadow: 0 3px 9px rgba(92,58,33,0.7);
      position: relative;
      z-index: 1000;
      flex-wrap: wrap;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo img {
      width: 56px; height: 56px; border-radius: 8px;
      box-shadow: 0 3px 7px rgba(0,0,0,0.15);
    }
    .location {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      color: #ffd366;
      margin-left: 5px;
      user-select: none;
    }
    .location i { color: #d81ba0; }
    .location-select {
      font-size: 1rem;
      padding: 5px 12px;
      border-radius: 7px;
      border: 1.3px solid #7f58e7;
      color: #5c3a21;
      background: #fffdf5;
      font-weight: 600;
      min-width: 162px;
      outline: none;
      margin-left: 7px;
    }
    .location-select:focus { border: 1.4px solid #d81ba0; }
    .nav-main {
      display: flex;
      align-items: center;
      gap: 22px;
      flex: 1;
      justify-content: center;
      min-width: 240px;
      user-select: none;
    }
    .category-dropdown {
      border-radius: 8px;
      padding: 7px 14px;
      font-size: 15px;
      background: #f7f0ff;
      color: #5c3a21;
      border: 1.3px solid #d81ba0;
      font-weight: 600;
      cursor: pointer;
      min-width: 120px;
      transition: border-color 0.2s;
    }
    .category-dropdown:hover, .category-dropdown:focus {
      border-color: #7f58e7;
      box-shadow:0 0 8px #e1caef80;
    }
    .search-bar {
      display: flex;
      align-items: center;
      border-radius: 12px;
      background: #fcf3ff;
      overflow: hidden;
      box-shadow: 0 0 15px #d81ba020;
      border: 1.1px solid #e9cef4;
    }
    .search-bar input {
      padding: 9px 15px;
      border: none; min-width: 190px;
      background: transparent;
      outline: none;
      font-size: 15px;
      color: #5c3a21;
    }
    .search-bar button {
      border: none;
      background: #d81ba0;
      color: #fff;
      padding: 9px 13px 9px 12px;
      transition: background 0.21s;
      cursor: pointer;
      font-size: 1em;
    }
    .search-bar button:hover { background: #7f58e7;}
    .auth-cart {
      display: flex; align-items: center; gap: 14px;
    }
    .auth-cart a, .auth-cart span {
      color: #fff;
      background: #d81ba0;
      font-size: 1em;
      font-weight: 600;
      text-decoration: none;
      padding: 7px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.22s;
    }
    .auth-cart a:hover { background: #7f58e7;}
    .auth-cart .fa-shopping-cart {
      background: none;
      font-size: 21px;
      color: #fff !important;
      margin-left: 2px;
      position: relative;
    }
    #cart-count {
      position: absolute;
      top: -8px; right: -10px;
      background: #7f58e7;
      color: white; font-size: 11px; padding: 2px 6px;
      border-radius: 50%;
      font-weight: bold; user-select: none;
    }
    .hero {
      text-align: center;
      color: #5c3a21;
      padding: 56px 16px 34px;
      max-width: 600px;
      margin: 20px auto 38px;
      border-radius: 15px;
      background: #fff0fa;
      box-shadow: 0 0 20px rgba(128, 60, 131, 0.16);
    }
    .hero h2 { font-size: 2.3rem; margin-bottom: 14px; color: #7f58e7; font-weight: 700;}
    .hero p { font-size: 1.09rem; color: #6a4f73; letter-spacing: 0.01ch; line-height: 1.5;}
    .store-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 32px 3vw;
      gap: 28px;
      max-width: 1200px;
      margin: 0 auto 58px;
    }
    .store-card {
      background: #fff0fa;
      color: #5c3a21;
      padding: 18px 10px 16px;
      border-radius: 13px;
      min-width: 200px;
      max-width: 240px;
      box-shadow: 0 6px 12px #b97fc099;
      cursor: pointer;
      transition: box-shadow .22s, transform .17s;
      border: 1.1px solid #d81ba0;
      text-align: center;
      position: relative;
    }
    .store-card:hover {
      background: #e9d6f9;
      box-shadow: 0 12px 26px #7f58e7aa;
      transform: translateY(-5px) scale(1.05);
      border-color: #7f58e7;
    }
    .store-card img {
      width: 66px;
      height: 66px;
      margin: 8px auto 13px;
      border-radius: 11px;
      object-fit: cover;
      box-shadow: 0 5px 12px #ae73cdbe;
    }
    .store-card h3 {
      margin: 4px 0 6px;
      font-size: 1.12em;
      font-weight: 700;
      letter-spacing: 0.03ch;
      color: #5c3a21;
    }
    .category-badge {
      display: inline-block;
      border-radius: 7px;
      font-size: 12px;
      background: #d5c1f7;
      color: #4a3052;
      padding: 3px 11px;
      margin-bottom: 6px;
      font-weight: 600;
      box-shadow: 0 1.5px 0 #bfb5f8;
    }
    .store-dist {
      font-size: 12px;
      color: #835f9e;
      margin: 3px;
      font-weight: 500;
    }
    /* Item card (for shop product list) */
    .item-card {
      background: #edddfa;
      border: 1px solid #bd57cf;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e5a7ff44;
      padding: 18px 10px 14px;
      margin: 0 1.8vw 15px 1.8vw;
      width: 208px;
      max-width: 97vw;
      text-align: center;
      display: inline-block;
      vertical-align: top;
      transition: box-shadow 0.16s;
      cursor: default;
      user-select: none;
    }
    .item-card img {
      width: 64px; height: 64px; border-radius: 8px;
      object-fit: cover;
      margin-bottom: 10px;
      background: #fff;
    }
    .item-card h4 {
      margin: 2px 0 4px; font-size: 1.09em; color: #6a367e; font-weight: 700;
    }
    .item-type-badge {
      display:inline-block;background:#f6edfe;color:#772677;border-radius:6px;padding:2px 10px;font-size:12px;font-weight:600;margin-bottom:7px;
    }
    .item-card-desc {font-size:0.99em;color:#958aad;margin:2px 0 7px;}
    .item-card-price {font-size:1.09em;color:#D81BA0;font-weight:bold;letter-spacing:.02ch;}
    .item-card button {
      background: #d81ba0;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 6px 17px;
      margin-top: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: .97em;
      transition: background .18s;
    }
    .item-card button:hover { background: #7f58e7;}
    .item-card:focus-within,
    .item-card:focus-visible { outline:2px solid #9659ba; }
    /* Modal for login */
    .login-modal {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: rgba(48, 21, 62, .83);
      z-index: 5001;
      justify-content: center;
      align-items: center;
    }
    .login-modal.active { display: flex; }
    .login-unique-card {
      background: linear-gradient(135deg,#ffeeff 40%,#ddbefc 100%);
      color: #7c3889;
      border-radius: 18px;
      box-shadow: 0 3px 34px #bb54e8aa;
      min-width: 260px;
      max-width: 340px;
      width: 92vw;
      padding: 36px 27px 28px;
      margin: auto;
      text-align: center;
      border: 2.4px solid #9e57b7;
      position: relative;
      animation: popcard .30s;
    }
    @keyframes popcard {
      from { transform: scale(0.85); opacity: 0;}
      to { transform: scale(1); opacity: 1;}
    }
    .login-unique-card h2 {
      font-size: 2em; font-weight: 800; color: #a032c2; margin-bottom: 10px;
      font-family: 'Poppins',sans-serif;
      letter-spacing: .02ch;
    }
    .login-unique-card p {
      color: #6a277b; font-size: 1.1em; font-weight: 500; margin-bottom: 21px;
      line-height: 1.5;
    }
    .login-unique-btn {
      background: linear-gradient(87deg,#d81ba0 70%,#7f58e7);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 11px 33px;
      font-size: 1.09em;
      font-weight: 700;
      margin: 0 6px 12px 6px;
      transition: background .15s;
      cursor: pointer;
      box-shadow: 0 2px 16px #dab6ee22;
      outline:none;
    }
    .login-unique-btn:hover {
      background: linear-gradient(87deg,#7f58e7 60%,#d81ba0 90%)
    }
    .login-unique-card .or {
      display: block; color: #ad80d6; margin:6px 0 16px 0; font-size: 13px; font-weight: 700;
      letter-spacing: .06ch;
    }
    .close-login-modal {
      background: none; border: none; color: #e14d96; font-size: 1.7em; font-weight: 700;
      position: absolute; top: 7px; right: 18px; cursor: pointer; outline:none;
      transition: color .1s;
      padding: 0 3px;
    }
    .close-login-modal:hover { color: #723b8c;}
    footer {
      color: #9575cd; font-size: 1em;
      margin-bottom: 16px; margin-top: 10px; user-select: none; background:none;
    }
    footer a { color:#b07def; font-weight:600;}
    @media (max-width:700px) {
      header {padding:8px 6vw; flex-direction: column;}
      .nav-main {padding:10px 0; min-width:115px;}
      .store-section { flex-direction: column; padding:20px 2vw;}
      .store-card,.item-card {max-width: 97vw;}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="{{ url_for('static', filename='images/jiboncare_Logo.png') }}" alt="HaatXpress Logo" />
      <div class="location" aria-live="polite" aria-atomic="true">
        <i class="fas fa-map-marker-alt"></i>
        <select id="location-select" class="location-select" onchange="handleLocationChange()" aria-label="Choose Assam location">
          <option value="">Select Area, Town or District</option>
          <optgroup label="Kamrup Metro">
            <option value="Guwahati">Guwahati</option>
            <option value="Khanapara">Khanapara</option>
            <option value="Maligaon">Maligaon</option>
            <option value="Beltola">Beltola</option>
          </optgroup>
          <optgroup label="Dibrugarh">
            <option value="Dibrugarh">Dibrugarh Town</option>
            <option value="Chabua">Chabua</option>
            <option value="Naharkatia">Naharkatia</option>
          </optgroup>
          <optgroup label="Jorhat">
            <option value="Jorhat">Jorhat Town</option>
            <option value="Teok">Teok</option>
            <option value="Titabor">Titabor</option>
          </optgroup>
          <optgroup label="Cachar">
            <option value="Silchar">Silchar</option>
            <option value="Katigorah">Katigorah</option>
          </optgroup>
          <optgroup label="Barpeta">
            <option value="Barpeta">Barpeta</option>
            <option value="Howly">Howly</option>
          <optgroup label="Bajali">
            <option value="Pathsala">Pathsala</option>
          </optgroup>
          </optgroup>
          <optgroup label="Sonitpur">
            <option value="Tezpur">Tezpur</option>
            <option value="Biswanath">Biswanath Chariali</option>
          </optgroup>
          <optgroup label="More">
            <option value="Tinsukia">Tinsukia</option>
            <option value="Sibsagar">Sibsagar</option>
            <option value="Nagaon">Nagaon</option>
            <option value="Mangaldoi">Mangaldoi</option>
            <option value="Goalpara">Goalpara</option>
            <option value="Dhemaji">Dhemaji</option>
            <option value="Lakhimpur">Lakhimpur</option>
            <option value="Dhubri">Dhubri</option>
            <option value="Bongaigaon">Bongaigaon</option>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="nav-main">
      <label for="categorySelect" style="color:#fff;font-weight:600;margin-right:6px;">Category:</label>
      <select id="categorySelect" class="category-dropdown" onchange="categoryChanged()" aria-label="Select category">
        <option value="">All</option>
        <option value="grocery">Grocery</option>
        <option value="medicine">Medicine</option>
        <option value="food-item">Restaurant</option>
      </select>
      <div class="search-bar">
        <input id="searchInput" type="text" placeholder="Search store or item…" onkeyup="triggerSmartSearch()" aria-label="Search stores, items or seller"/>
        <button aria-label="Search"><i class="fas fa-search"></i></button>
      </div>
    </div>
    <div class="auth-cart">
      {% if user_email %}
      <span id="user-email" style="color:#FFD366;" aria-label="User email">{{ user_email }}</span>
      <a href="/logout" role="button" aria-label="Logout">Logout</a>
      {% else %}
      <a href="/register" role="button" aria-label="Register">Register</a>
      <a href="/login" role="button" aria-label="Login">Login</a>
      {% endif %}
      <a href="#" role="button" aria-label="Shopping cart">
        <i class="fas fa-shopping-cart" style="position: relative;">
          <span id="cart-count">0</span>
        </i>
      </a>
    </div>
  </header>

  <section class="hero" role="banner">
    <h2>Welcome to HaatXpress</h2>
    <p>
      Connecting you directly to local shops - groceries, medicines, food, all
      from your trusted neighborhood within your zone. Stay happy😀❤️
    </p>
  </section>
  <section class="store-section" id="store-list" aria-label="List of shops">
    <div style="color:#5C3A21;text-align:center;width:100%;">Please select your location in the dropdown to see shops.</div>
  </section>
  <section class="store-section" id="items-list" aria-label="Items uploaded by selected shop">
    <div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>
  </section>


  <!-- Stylish Modal for Login/Register -->
  <div class="login-modal" id="loginPromptModal" tabindex="-1" aria-hidden="true">
    <div class="login-unique-card" tabindex="0" aria-modal="true" role="dialog" aria-labelledby="loginPromptTitle">
      <button class="close-login-modal" onclick="closeLoginPrompt()" aria-label="Close">&times;</button>
      
      <p>To add items to your cart<br>please Login or Register below.</p>
      <a href="/login" class="login-unique-btn" aria-label="Login">Login</a>
      <span class="or">OR</span>
      <a href="/register" class="login-unique-btn" aria-label="Register">Register</a>
    </div>
  </div>
<center>
  <footer role="contentinfo">
    <p>&copy; 2025 HaatXpress. Made with 🧡 for your neighborhood.</p>
    <p>
      Contact: <a href="mailto:support@haatexpress.com">support@haatexpress.com</a>
    </p>
  </footer>
</center>
  <script>
    // Variables
    let userLocation = null;
    const isUserLoggedIn = !!document.getElementById("user-email");
    let cartCount = 0;
    let CURRENT_SHOPS = [];
    let CURRENT_CATEGORY = "";
    let SEARCH_TEXT = "";

    // Submit user location
    function submitUserLocation() {
      const input = document.getElementById("user-location-input");
      const location = input.value.trim();
      if (!location) {
        alert("Please enter a valid location.");
        return;
      }
      userLocation = location;
      document.getElementById("locationModal").classList.remove("active");
      updateHeaderLocation();
      fetchShopsByArea(userLocation);
    }

    // Update header location display and button
    function updateHeaderLocation() {
      const locationText = document.getElementById("location-text");
      locationText.textContent = userLocation + " ";
      if (!document.getElementById("change-location-btn")) {
        const locationDiv = locationText.parentElement;
        const btn = document.createElement("button");
        btn.id = "change-location-btn";
        btn.textContent = "Change";
        btn.style.cssText =
          "margin-left:8px; background:#D81BA0; color:#fff; border:none; border-radius:5px; padding:3px 10px; cursor:pointer; font-weight:600;";
        btn.setAttribute("aria-label", "Change your location");
        btn.onmouseenter = () => (btn.style.backgroundColor = "#7f58e7");
        btn.onmouseleave = () => (btn.style.backgroundColor = "#D81BA0");
        btn.onclick = openLocationModal;
        locationDiv.appendChild(btn);
      }
    }
    function openLocationModal() {
      document.getElementById("locationModal").classList.add("active");
      document.getElementById("user-location-input").value = "";
    }

    // Fetch shops by area from API
    function fetchShopsByArea(area) {
      const storeList = document.getElementById("store-list");
      storeList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Loading shops...</div>`;
      fetch(`/api/shops?area=${encodeURIComponent(area)}`)
        .then((response) => {
          if (!response.ok) throw new Error("API error");
          return response.json();
        })
        .then((data) => {
          CURRENT_SHOPS = data.shops || data;
          CURRENT_CATEGORY = "";
          SEARCH_TEXT = "";
          showShops(CURRENT_SHOPS);
          resetFilters();
        })
        .catch(() => {
          storeList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Error loading shops.</div>`;
        });
    }

    // Show shops in UI
    function showShops(shops) {
      const storeList = document.getElementById("store-list");
      if (!shops || shops.length === 0) {
        storeList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">No shops found in your area.</div>`;
        return;
      }
      storeList.innerHTML = "";
      shops.forEach((shop) => {
        const shopElem = document.createElement("div");
        shopElem.className = "store-card";
        shopElem.tabIndex = 0;
        shopElem.setAttribute("role", "region");
        shopElem.setAttribute("aria-label", `${shop.name} shop`);
        shopElem.innerHTML = `
          <img src="${shop.image_url || "/static/default-avatar.png"}" alt="${shop.name} shop image" />
          <div class="category-badge">${capitalize(shop.category)}</div>
          <h3>${shop.name}</h3>
          <div class="store-dist">${shop.distance ? `${shop.distance} km away` : ""}</div>
          `;
        shopElem.addEventListener("click", () => {
          openMenuModal(shop.id, shop.name);
          if (shop.email) fetchItemsBySeller(shop.email);
          else
            document.getElementById("items-list").innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">No items info available for this shop.</div>`;
        });
        shopElem.addEventListener("keypress", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            openMenuModal(shop.id, shop.name);
            if (shop.email) fetchItemsBySeller(shop.email);
          }
        });
        storeList.appendChild(shopElem);
      });
      // Clear items-list if shops refreshed
      document.getElementById("items-list").innerHTML =
        '<div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>';
    }

    // Fetch items for selected seller
    function fetchItemsBySeller(sellerEmail) {
      const itemsList = document.getElementById("items-list");
      itemsList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Loading items...</div>`;
      fetch(`/api/items?seller_email=${encodeURIComponent(sellerEmail)}`)
        .then((res) => {
          if (!res.ok) throw new Error("Failed to fetch items");
          return res.json();
        })
        .then((data) => {
          const items = data.items || [];
          if (items.length === 0) {
            itemsList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">No items found for this shop.</div>`;
            return;
          }
          displayItems(items);
        })
        .catch(() => {
          itemsList.innerHTML = `<div style="color:#5C3A21;text-align:center;width:100%;">Error loading items.</div>`;
        });
    }

    // Show items in UI
    function displayItems(items) {
      const itemsList = document.getElementById("items-list");
      itemsList.innerHTML = "";
      items.forEach((item) => {
        const card = document.createElement("div");
        card.className = "store-card";
        card.innerHTML = `
          <img src="${item.image_url || "/static/default-avatar.png"}" alt="${item.name}" />
          <div class="category-badge">${capitalize(item.type)}</div>
          <h3>${item.name}</h3>
          <div class="store-dist">₹${item.price.toFixed(2)}</div>
          <button aria-label="Add ${item.name} to cart" style="background:#D81BA0; color:#fff; border:none; border-radius:8px; padding:6px 12px; cursor:pointer; font-weight:bold;">
          Add to Cart
          </button>
          `;
        const btn = card.querySelector("button");
        btn.addEventListener("click", () => handleAddToCart(item));
        itemsList.appendChild(card);
      });
    }

    function capitalize(str) {
      if (!str) return "";
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Menu modal controls
    function openMenuModal(shopId, shopName) {
      const menuModal = document.getElementById("menuModal");
      const menuTitle = document.getElementById("menuModalTitle");
      const menuContent = document.getElementById("menuContent");

      menuTitle.textContent = `Menu - ${shopName}`;
      menuContent.innerHTML = `<p>Loading menu...</p>`;
      menuModal.setAttribute("aria-hidden", "false");
      menuModal.classList.add("active");
      menuModal.focus();

      fetch(`/api/shop/${shopId}/menu`)
        .then((resp) => {
          if (!resp.ok) throw new Error("Failed to fetch menu");
          return resp.json();
        })
        .then((data) => {
          if (!data || !Array.isArray(data.menu) || data.menu.length === 0) {
            menuContent.innerHTML = `<p>No menu items found.</p>`;
            return;
          }
          renderMenuItems(data.menu);
        })
        .catch(() => {
          menuContent.innerHTML = `<p>Failed to load menu. Please try again later.</p>`;
        });
    }

    function renderMenuItems(items) {
      const menuContent = document.getElementById("menuContent");
      menuContent.innerHTML = "<ul></ul>";
      const ul = menuContent.querySelector("ul");
      items.forEach((item) => {
        const li = document.createElement("li");
        const itemInfo = document.createElement("div");
        itemInfo.className = "item-info";

        const itemName = document.createElement("div");
        itemName.className = "item-name";
        itemName.textContent = item.name;

        const itemDesc = document.createElement("div");
        itemDesc.className = "item-desc";
        if (item.description) {
          itemDesc.textContent = item.description;
        } else {
          itemDesc.textContent = "";
        }

        itemInfo.appendChild(itemName);
        if (item.description) itemInfo.appendChild(itemDesc);

        const itemPrice = document.createElement("div");
        itemPrice.className = "item-price";
        itemPrice.textContent = `₹${item.price.toFixed(2)}`;

        const addButton = document.createElement("button");
        addButton.textContent = "Add to Cart";
        addButton.setAttribute("aria-label", `Add ${item.name} to cart`);
        addButton.onclick = () => handleAddToCart(item);

        li.appendChild(itemInfo);
        li.appendChild(itemPrice);
        li.appendChild(addButton);

        ul.appendChild(li);
      });
    }

    function closeMenuModal() {
      const menuModal = document.getElementById("menuModal");
      menuModal.classList.remove("active");
      menuModal.setAttribute("aria-hidden", "true");
    }

    // Add to cart handler
    function handleAddToCart(item) {
      if (!isUserLoggedIn) {
        openLoginPrompt();
        return;
      }
      cartCount++;
      updateCartCount();
      alert(`Added "${item.name}" to cart.`);
    }

    function updateCartCount() {
      const cartCountElem = document.getElementById("cart-count");
      cartCountElem.textContent = cartCount;
    }

// Stylish Login Modal controls
function openLoginPrompt() {
  const m = document.getElementById("loginPromptModal");
  m.classList.add("active");
  m.setAttribute("aria-hidden", "false");
  setTimeout(()=>{try{m.querySelector('.login-unique-card').focus();}catch(e){}},140);
}
function closeLoginPrompt() {
  const m = document.getElementById("loginPromptModal");
  m.classList.remove("active");
  m.setAttribute("aria-hidden", "true");
}

// Filter/SMART SEARCH: matches shop name, address, product names—even product search!
function triggerSmartSearch() {
  SEARCH_TEXT = document.getElementById("searchInput").value.trim().toLowerCase();
  if (!CURRENT_SHOPS || !Array.isArray(CURRENT_SHOPS)) return;
  if (!SEARCH_TEXT) {
    applyFilters();
    return;
  }
  // Search across shops and their items
  let results = [];
  let searchByItem = [];
  CURRENT_SHOPS.forEach(shop=>{
    const sText = ((shop.name||"")+" "+(shop.address||"")+" "+(shop.contact||"")).toLowerCase();
    // Find if this shop has an item that matches
    let match = false, foundItem=null;
    if (ALL_ITEMS_BY_SHOP[shop.id]) {
      ALL_ITEMS_BY_SHOP[shop.id].forEach(it=>{
        if (it.name && it.name.toLowerCase().includes(SEARCH_TEXT)) match=true;
        if (!foundItem && it.name && it.name.toLowerCase().includes(SEARCH_TEXT)) foundItem=it;
      });
    }
    if (sText.includes(SEARCH_TEXT)) {
      results.push(shop);
    } else if (match) {
      searchByItem.push(shop);
    }
  });
  // If smart search matches product, show only those shops!
  let filtered = [...results, ...searchByItem.filter(s=>!results.includes(s))];
  showShops(filtered);
  // If user types an item, clicking the shop will show its products, and search highlight
  document.getElementById('items-list').innerHTML='<div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>';
}
function capitalize(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// Apply category filter (on already loaded shops)
function categoryChanged() {
  CURRENT_CATEGORY = document.getElementById("categorySelect").value;
  applyFilters();
}
function applyFilters() {
  let filtered = CURRENT_SHOPS;
  if (CURRENT_CATEGORY && CURRENT_CATEGORY !== "")
    filtered = filtered.filter(shop => shop.category === CURRENT_CATEGORY);
  if (SEARCH_TEXT && SEARCH_TEXT.length > 0) {
    // Use smart search instead!
    triggerSmartSearch();
    return;
  }
  showShops(filtered);
  document.getElementById("items-list").innerHTML =
    '<div style="color:#5C3A21;text-align:center;width:100%;">Select a shop to view its items.</div>';
}

// Keyboard modal controls
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") { closeLoginPrompt(); }
});

// On reload, re-apply location if exists
window.onload = function() {
  isUserLoggedIn = !!document.getElementById("user-email");
  restoreLocationFromLocalStorage();
};
</script>
</body>
</html>
